<!doctype html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BOMBA BET - SportAPI7 Edition</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background:#0a0a0f; color:#e4e4e7; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto; }
    .glass { background: rgba(255,255,255,0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.08); }
    .loader { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg);} to { transform: rotate(360deg);} }
    .conf-high { color:#00d4aa; } .conf-mid{ color:#f59e0b; } .conf-low { color:#ef4444; }
    .match-card:hover { background: rgba(255,255,255,0.06); cursor:pointer; }
    button:disabled { opacity: .55; cursor: not-allowed; }
  </style>
</head>
<body>
  <div id="app" class="max-w-2xl mx-auto min-h-screen flex flex-col">
    <header class="glass sticky top-0 z-50 border-b border-white/5">
      <div class="px-4 py-3 flex items-center justify-between gap-3">
        <div class="flex items-center gap-3 min-w-0">
          <div id="sportBadge" class="w-10 h-10 rounded-xl bg-gradient-to-br from-emerald-400 to-cyan-500 flex items-center justify-center text-black font-black">
            BB
          </div>
          <div class="min-w-0">
            <div class="font-black text-white leading-tight">BOMBA BET</div>
            <div class="text-[11px] text-gray-400 leading-tight">SportAPI7 (RapidAPI) ‚Ä¢ anti-429</div>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <button id="btnKey" class="glass px-3 py-2 rounded-lg text-xs font-bold hover:bg-white/10">Imposta Key</button>
          <button id="btnClearCache" class="glass px-3 py-2 rounded-lg text-xs font-bold text-red-300 hover:bg-white/10">Reset</button>
        </div>
      </div>

      <div class="px-4 pb-3 flex flex-col gap-2">
        <div class="flex gap-2 glass rounded-xl p-1">
          <button data-sport="football" class="sportBtn flex-1 py-2 rounded-lg text-xs font-bold bg-gradient-to-r from-emerald-400 to-cyan-500 text-gray-900">Calcio</button>
          <button data-sport="basketball" class="sportBtn flex-1 py-2 rounded-lg text-xs font-bold text-gray-300 hover:bg-white/5 rounded-lg">Basket</button>
          <button data-sport="tennis" class="sportBtn flex-1 py-2 rounded-lg text-xs font-bold text-gray-300 hover:bg-white/5 rounded-lg">Tennis</button>
        </div>

        <div class="flex gap-2 items-center">
          <input id="dateInput" type="date" class="glass w-full px-3 py-2 rounded-lg text-sm text-white" />
          <button id="btnLoad" class="glass px-4 py-2 rounded-lg text-sm font-bold hover:bg-white/10 whitespace-nowrap">Carica</button>
        </div>

        <div id="statusLine" class="text-[11px] text-gray-400"></div>
      </div>
    </header>

    <main class="flex-1 p-4 pb-6">
      <div id="content"></div>
    </main>

    <footer class="px-4 pb-6 text-[11px] text-gray-500">
      Nota: se ottieni 429, riduci i click e attendi; il codice fa throttle+retry automatico. (Se l‚Äôendpoint ‚Äúscheduled-events‚Äù non esiste nella tua sottoscrizione, cambia la stringa ENDPOINTS qui sotto.)
    </footer>
  </div>

<script>
/* ============================================================
   SPORTAPI7 (RapidAPI) - BASE
   ============================================================ */

// Host visto nel tuo screen (sportapi7.p.rapidapi.com) [file:17]
const RAPIDAPI_HOST = "sportapi7.p.rapidapi.com";

// Base path /api/v1 coerente con l‚Äôesempio nel tuo screen [file:17]
const API_BASE = "/api/v1";

// IMPORTANT: gli endpoint possono variare in base alla versione/provider.
// Qui sono raggruppati in un oggetto per modificarli in 1 punto solo.
const ENDPOINTS = {
  // Tentativo ‚Äústile Sofascore‚Äù: /api/v1/sport/{sport}/scheduled-events/{YYYY-MM-DD}
  // Se nel Playground RapidAPI √® diverso, modifica QUI.
  scheduledEvents: (sport, date) => `${API_BASE}/sport/${sport}/scheduled-events/${date}`,

  // Dettaglio evento
  event: (eventId) => `${API_BASE}/event/${eventId}`,

  // Statistiche (non sempre disponibile per tutti gli sport; se 404, verr√† ignorato)
  eventStats: (eventId) => `${API_BASE}/event/${eventId}/statistics`,
};

// Key in localStorage (non inserita nel codice) [file:1]
let RAPIDAPI_KEY = localStorage.getItem("RAPIDAPI_KEY") || "";

function setStatus(msg) {
  document.getElementById("statusLine").textContent = msg || "";
}

function promptKey() {
  const k = prompt("Incolla la tua RapidAPI Key (verr√† salvata in questo browser):", RAPIDAPI_KEY || "");
  if (!k) return;
  RAPIDAPI_KEY = k.trim();
  localStorage.setItem("RAPIDAPI_KEY", RAPIDAPI_KEY);
  setStatus("Key salvata nel browser.");
}

document.getElementById("btnKey").addEventListener("click", promptKey);

document.getElementById("btnClearCache").addEventListener("click", () => {
  // Pulisce key + cache
  localStorage.removeItem("RAPIDAPI_KEY");
  Object.keys(localStorage).forEach(k => { if (k.startsWith("bb_cache:")) localStorage.removeItem(k); });
  RAPIDAPI_KEY = "";
  state.matches = [];
  state.selected = null;
  state.error = null;
  setStatus("Reset completato.");
  render();
});

// Throttle + Retry 429 (riduce ‚Äúraffiche‚Äù e aiuta con rate limit) [web:6]
const MIN_GAP_MS = 650;
let _lastReqTs = 0;
async function throttle() {
  const now = Date.now();
  const wait = Math.max(0, MIN_GAP_MS - (now - _lastReqTs));
  if (wait > 0) await new Promise(r => setTimeout(r, wait));
  _lastReqTs = Date.now();
}

async function fetchWith429Retry(url, options, maxRetries = 4) {
  let last = null;
  for (let attempt = 0; attempt <= maxRetries; attempt++) {
    await throttle();
    const res = await fetch(url, options);
    last = res;

    if (res.status !== 429) return res;

    const ra = res.headers.get("retry-after"); // standard, se presente
    const retryAfterMs = ra ? (parseInt(ra, 10) * 1000) : 0;
    const backoffMs = Math.round(900 * Math.pow(2, attempt)); // 0.9s, 1.8s, 3.6s...
    const sleepMs = retryAfterMs > 0 ? retryAfterMs : backoffMs;
    setStatus(`429: attendo ${Math.round(sleepMs/1000)}s e riprovo...`);
    await new Promise(r => setTimeout(r, sleepMs));
  }
  return last;
}

const CACHE_TTL_MS = 45 * 1000;
function cacheGet(key) {
  try {
    const raw = localStorage.getItem(key);
    if (!raw) return null;
    const obj = JSON.parse(raw);
    if (!obj?.t) return null;
    if ((Date.now() - obj.t) > CACHE_TTL_MS) return null;
    return obj.v;
  } catch { return null; }
}
function cacheSet(key, value) {
  try { localStorage.setItem(key, JSON.stringify({t: Date.now(), v: value})); } catch {}
}

async function apiGet(path) {
  if (!RAPIDAPI_KEY) throw new Error("RapidAPI Key mancante. Clicca 'Imposta Key'.");
  const url = `https://${RAPIDAPI_HOST}${path}`;
  const cacheKey = `bb_cache:${url}`;
  const cached = cacheGet(cacheKey);
  if (cached) return cached;

  const res = await fetchWith429Retry(url, {
    method: "GET",
    headers: {
      "X-RapidAPI-Key": RAPIDAPI_KEY,
      "X-RapidAPI-Host": RAPIDAPI_HOST,
    }
  });

  if (!res?.ok) {
    let extra = "";
    try { extra = (await res.text() || "").slice(0, 200); } catch {}
    throw new Error(`HTTP ${res ? res.status : "?"}${extra ? " - " + extra : ""}`);
  }

  const data = await res.json();
  cacheSet(cacheKey, data);
  return data;
}

/* ============================================================
   APP STATE + UI
   ============================================================ */

const state = {
  sport: "football",
  date: new Date().toISOString().slice(0,10),
  loading: false,
  error: null,
  matches: [],
  selected: null,
};

const sportMeta = {
  football: { label: "Calcio", badge: "‚öΩ", gradient: "from-emerald-400 to-cyan-500" },
  basketball: { label: "Basket", badge: "üèÄ", gradient: "from-orange-400 to-yellow-500" },
  tennis: { label: "Tennis", badge: "üéæ", gradient: "from-purple-400 to-pink-500" },
};

document.getElementById("dateInput").value = state.date;
document.getElementById("dateInput").addEventListener("change", (e) => {
  state.date = e.target.value;
});

document.querySelectorAll(".sportBtn").forEach(btn => {
  btn.addEventListener("click", () => {
    state.sport = btn.dataset.sport;
    state.matches = [];
    state.selected = null;
    state.error = null;
    setStatus("");
    updateHeader();
    updateSportButtons();
    render();
  });
});

function updateHeader() {
  const meta = sportMeta[state.sport];
  const badge = document.getElementById("sportBadge");
  badge.className = `w-10 h-10 rounded-xl bg-gradient-to-br ${meta.gradient} flex items-center justify-center text-black font-black`;
  badge.textContent = meta.badge;
}

function updateSportButtons() {
  document.querySelectorAll(".sportBtn").forEach(b => {
    const on = b.dataset.sport === state.sport;
    b.className = "sportBtn flex-1 py-2 rounded-lg text-xs font-bold " + (on
      ? `bg-gradient-to-r ${sportMeta[state.sport].gradient} text-gray-900`
      : "text-gray-300 hover:bg-white/5");
  });
}

function confClass(v) {
  if (v >= 65) return "conf-high";
  if (v >= 52) return "conf-mid";
  return "conf-low";
}

function fmtDate(tsSeconds) {
  try {
    if (!tsSeconds) return "--";
    const d = new Date(tsSeconds * 1000);
    return d.toLocaleString("it-IT", { weekday:"short", day:"2-digit", month:"2-digit", hour:"2-digit", minute:"2-digit" });
  } catch { return "--"; }
}

function normalizeScheduledEventsResponse(data) {
  // Molte API ‚Äústile Sofascore‚Äù tornano { events: [...] }
  // Se la tua risposta √® diversa, modifica qui.
  const events = data?.events || data?.response || data?.data || [];
  return Array.isArray(events) ? events : [];
}

function extractMatchModel(ev) {
  // Mappa ‚Äútollerante‚Äù per non rompersi se cambiano i campi
  const id = ev?.id ?? ev?.event?.id ?? ev?.fixture?.id ?? null;

  const home = ev?.homeTeam?.name || ev?.home?.name || ev?.teams?.home?.name || ev?.player1?.name || "Home";
  const away = ev?.awayTeam?.name || ev?.away?.name || ev?.teams?.away?.name || ev?.player2?.name || "Away";

  const tournament = ev?.tournament?.name || ev?.league?.name || ev?.competition?.name || ev?.category?.name || "‚Äî";

  const startTs = ev?.startTimestamp || ev?.startTime || ev?.fixture?.timestamp || null;

  const homeLogo = ev?.homeTeam?.logo || ev?.homeTeam?.teamLogo || ev?.home?.logo || ev?.teams?.home?.logo || null;
  const awayLogo = ev?.awayTeam?.logo || ev?.awayTeam?.teamLogo || ev?.away?.logo || ev?.teams?.away?.logo || null;

  return { id, home, away, tournament, startTs, raw: ev, homeLogo, awayLogo };
}

/* ============================================================
   MINI ANALISI (come nel tuo stile originale, ma senza dipendere dal provider)
   ============================================================ */

// DB ‚Äúsemplice‚Äù (puoi incollare i tuoi valori reali qui, se vuoi)
const TEAMSTATS = {
  "Juventus": { corners: 5.8, cornersAg: 4.2, cards: 2.1, cardsAg: 1.8, gf: 1.8, ga: 0.9, ggRate: 48 },
  "Inter": { corners: 6.2, cornersAg: 3.8, cards: 1.9, cardsAg: 2.0, gf: 2.4, ga: 0.8, ggRate: 52 },
  "Milan": { corners: 5.5, cornersAg: 4.5, cards: 2.3, cardsAg: 1.9, gf: 2.1, ga: 1.1, ggRate: 58 },
};

function getTeamStats(name) {
  if (!name) return { corners: 5.0, cornersAg: 5.0, cards: 2.0, cardsAg: 2.0, gf: 1.3, ga: 1.3, ggRate: 50 };
  const n = name.toLowerCase();
  for (const [k, v] of Object.entries(TEAMSTATS)) {
    const kk = k.toLowerCase();
    if (n.includes(kk) || kk.includes(n)) return v;
  }
  return { corners: 5.0, cornersAg: 5.0, cards: 2.0, cardsAg: 2.0, gf: 1.3, ga: 1.3, ggRate: 50 };
}

function analyzeFootballMatch(home, away) {
  const h = getTeamStats(home);
  const a = getTeamStats(away);

  const homeScoreProb = Math.min(95, (h.gf / 2.5) * 100);
  const awayScoreProb = Math.min(95, (a.gf / 2.5) * 100);
  const avgGGRate = (h.ggRate + a.ggRate) / 2;

  let ggProb = (homeScoreProb * awayScoreProb / 100) * 0.5 + avgGGRate * 0.5;
  ggProb = Math.max(25, Math.min(78, ggProb));

  const homeGoalsExp = (h.gf * 1.05 + a.ga * 0.95) / 2;
  const awayGoalsExp = (a.gf * 0.95 + h.ga * 1.05) / 2;
  const totalGoalsExp = homeGoalsExp + awayGoalsExp;

  const homeCornersExp = (h.corners * 1.08 + a.cornersAg * 0.92) / 2;
  const awayCornersExp = (a.corners * 0.92 + h.cornersAg * 1.08) / 2;
  const totalCornersExp = homeCornersExp + awayCornersExp;

  const homeCardsExp = (h.cards * 0.88 + a.cardsAg * 1.12) / 2;
  const awayCardsExp = (a.cards * 1.15 + h.cardsAg * 0.85) / 2;
  const totalCardsExp = homeCardsExp + awayCardsExp;

  const lines = (arr, baseConf, scale) => arr.map(line => ({
    line,
    pick: (scale > line) ? "OVER" : "UNDER",
    conf: Math.min(85, baseConf + Math.abs(scale - line) * 10)
  }));

  return {
    gg: { prob: ggProb, pick: ggProb >= 52 ? "GG" : "NG", conf: 45 + Math.abs(ggProb - 50) * 0.8 },
    goals: { exp: totalGoalsExp, lines: lines([1.5,2.5,3.5], 48, totalGoalsExp) },
    corners: { exp: totalCornersExp, lines: lines([8.5,9.5,10.5,11.5], 50, totalCornersExp) },
    cards: { exp: totalCardsExp, lines: lines([3.5,4.5,5.5], 48, totalCardsExp) },
  };
}

/* ============================================================
   LOAD + RENDER
   ============================================================ */

async function loadMatches() {
  if (state.loading) return;
  state.loading = true;
  state.error = null;
  state.matches = [];
  state.selected = null;
  setStatus("Caricamento...");
  render();

  try {
    const data = await apiGet(ENDPOINTS.scheduledEvents(state.sport, state.date));
    const events = normalizeScheduledEventsResponse(data);
    state.matches = events.map(extractMatchModel).filter(m => m.id != null || (m.home && m.away));
    if (state.matches.length === 0) {
      state.error = "Nessun evento trovato per questa data. (Controlla endpoint/abbonamento nel Playground.)";
    } else {
      setStatus(`Trovati: ${state.matches.length} eventi.`);
    }
  } catch (e) {
    state.error = "Errore: " + (e?.message || String(e));
    setStatus("");
  } finally {
    state.loading = false;
    render();
  }
}

document.getElementById("btnLoad").addEventListener("click", loadMatches);

function renderList() {
  const meta = sportMeta[state.sport];
  const parts = [];

  parts.push(`
    <div class="flex items-center justify-between mb-3">
      <h2 class="font-bold text-white">Eventi ‚Ä¢ ${meta.label}</h2>
      <div class="text-xs text-gray-400">${state.date}</div>
    </div>
  `);

  if (state.loading) {
    parts.push(`
      <div class="glass rounded-xl p-8 text-center">
        <div class="w-10 h-10 border-4 border-cyan-400 border-t-transparent rounded-full loader mx-auto mb-3"></div>
        <div class="text-gray-400 text-sm">Caricamento...</div>
      </div>
    `);
    return parts.join("");
  }

  if (state.error) {
    parts.push(`
      <div class="glass rounded-xl p-6 text-center">
        <div class="text-red-300 font-bold mb-2">${escapeHtml(state.error)}</div>
        <div class="text-xs text-gray-500">Se vedi 429: attendi; se vedi 404/nessun evento: controlla ENDPOINTS.scheduledEvents.</div>
      </div>
    `);
    return parts.join("");
  }

  if (!state.matches.length) {
    parts.push(`
      <div class="glass rounded-xl p-8 text-center">
        <div class="text-gray-400 text-sm mb-2">Nessun evento caricato.</div>
        <div class="text-xs text-gray-500">Clicca ‚ÄúCarica‚Äù.</div>
      </div>
    `);
    return parts.join("");
  }

  parts.push(`<div class="space-y-2">`);
  state.matches.forEach((m, i) => {
    parts.push(`
      <div class="glass rounded-xl p-3 match-card" data-id="${escapeHtml(String(m.id))}" style="animation-delay:${i*20}ms">
        <div class="flex items-center justify-between mb-2">
          <div class="text-[11px] text-cyan-300 font-medium truncate pr-2">${escapeHtml(m.tournament)}</div>
          <div class="text-[11px] text-gray-500">${escapeHtml(fmtDate(m.startTs))}</div>
        </div>
        <div class="flex items-center justify-between gap-2">
          <div class="flex items-center gap-2 min-w-0 flex-1">
            ${m.homeLogo ? `<img src="${escapeAttr(m.homeLogo)}" class="w-7 h-7 rounded" />` : `<div class="w-7 h-7 rounded bg-white/5"></div>`}
            <div class="font-bold text-white text-sm truncate">${escapeHtml(m.home)}</div>
          </div>
          <div class="text-gray-400 text-xs px-2">vs</div>
          <div class="flex items-center gap-2 min-w-0 flex-1 justify-end">
            <div class="font-bold text-white text-sm truncate text-right">${escapeHtml(m.away)}</div>
            ${m.awayLogo ? `<img src="${escapeAttr(m.awayLogo)}" class="w-7 h-7 rounded" />` : `<div class="w-7 h-7 rounded bg-white/5"></div>`}
          </div>
        </div>
        <div class="text-center mt-2 text-[11px] text-emerald-300">Clicca per analisi</div>
      </div>
    `);
  });
  parts.push(`</div>`);

  return parts.join("");
}

async function loadSelectedDetails(eventId) {
  if (!eventId) return;

  state.loading = true;
  state.error = null;
  setStatus("Caricamento dettagli...");
  render();

  try {
    const [eventData, statsData] = await Promise.allSettled([
      apiGet(ENDPOINTS.event(eventId)),
      apiGet(ENDPOINTS.eventStats(eventId)),
    ]);

    const ev = (eventData.status === "fulfilled") ? eventData.value : null;
    const st = (statsData.status === "fulfilled") ? statsData.value : null;

    // Tenta di estrarre campi dal dettaglio evento; fallback a quello della lista
    const base = state.matches.find(x => String(x.id) === String(eventId));
    const home = ev?.event?.homeTeam?.name || ev?.homeTeam?.name || base?.home || "Home";
    const away = ev?.event?.awayTeam?.name || ev?.awayTeam?.name || base?.away || "Away";
    const tournament = ev?.event?.tournament?.name || ev?.tournament?.name || base?.tournament || "‚Äî";
    const startTs = ev?.event?.startTimestamp || ev?.startTimestamp || base?.startTs || null;

    state.selected = {
      id: eventId,
      home, away, tournament, startTs,
      rawEvent: ev,
      rawStats: st,
    };

    setStatus("Dettagli caricati.");
  } catch (e) {
    state.error = "Errore dettagli: " + (e?.message || String(e));
    state.selected = null;
    setStatus("");
  } finally {
    state.loading = false;
    render();
  }
}

function renderSelected() {
  const s = state.selected;
  const meta = sportMeta[state.sport];

  const dt = fmtDate(s.startTs);
  let analysisHtml = "";

  if (state.sport === "football") {
    const a = analyzeFootballMatch(s.home, s.away);

    analysisHtml = `
      <div class="glass rounded-xl p-4 mb-3">
        <div class="flex items-center justify-between mb-2">
          <div class="font-bold">Goal/Goal</div>
          <div class="text-xs text-gray-400">Prob. stimata</div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="bg-black/30 rounded-lg p-3 text-center ${a.gg.pick === "GG" ? "ring-2 ring-emerald-500" : ""}">
            <div class="font-black text-xl text-white">GG</div>
            <div class="text-xs ${confClass(a.gg.conf)}">${a.gg.prob.toFixed(0)}%</div>
          </div>
          <div class="bg-black/30 rounded-lg p-3 text-center ${a.gg.pick === "NG" ? "ring-2 ring-emerald-500" : ""}">
            <div class="font-black text-xl text-white">NG</div>
            <div class="text-xs ${confClass(100 - a.gg.conf)}">${(100-a.gg.prob).toFixed(0)}%</div>
          </div>
        </div>
      </div>

      <div class="glass rounded-xl p-4 mb-3">
        <div class="font-bold mb-2">Goals <span class="text-xs text-gray-400 font-normal ml-2">Exp ${a.goals.exp.toFixed(1)}</span></div>
        <div class="space-y-2">
          ${a.goals.lines.map(l => `
            <div class="flex items-center justify-between bg-black/30 rounded-lg p-2">
              <div class="text-sm text-gray-300">${l.pick} ${l.line}</div>
              <div class="text-sm font-bold ${confClass(l.conf)}">${l.conf.toFixed(0)}</div>
            </div>
          `).join("")}
        </div>
      </div>

      <div class="glass rounded-xl p-4 mb-3">
        <div class="font-bold mb-2">Corner <span class="text-xs text-gray-400 font-normal ml-2">Exp ${a.corners.exp.toFixed(1)}</span></div>
        <div class="space-y-2">
          ${a.corners.lines.map(l => `
            <div class="flex items-center justify-between bg-black/30 rounded-lg p-2">
              <div class="text-sm text-gray-300">${l.pick} ${l.line}</div>
              <div class="text-sm font-bold ${confClass(l.conf)}">${l.conf.toFixed(0)}</div>
            </div>
          `).join("")}
        </div>
      </div>

      <div class="glass rounded-xl p-4">
        <div class="font-bold mb-2">Cartellini <span class="text-xs text-gray-400 font-normal ml-2">Exp ${a.cards.exp.toFixed(1)}</span></div>
        <div class="space-y-2">
          ${a.cards.lines.map(l => `
            <div class="flex items-center justify-between bg-black/30 rounded-lg p-2">
              <div class="text-sm text-gray-300">${l.pick} ${l.line}</div>
              <div class="text-sm font-bold ${confClass(l.conf)}">${l.conf.toFixed(0)}</div>
            </div>
          `).join("")}
        </div>
      </div>
    `;
  } else {
    analysisHtml = `
      <div class="glass rounded-xl p-4">
        <div class="font-bold mb-2">Dettagli</div>
        <div class="text-sm text-gray-300">Per Basket/Tennis la ‚Äúmini analisi‚Äù non √® implementata in questa versione.</div>
        <div class="text-xs text-gray-500 mt-2">Se mi incolli un esempio di risposta JSON ‚Äúevent‚Äù e/o ‚Äúscheduled-events‚Äù per basket/tennis, preparo le analisi dedicate.</div>
      </div>
    `;
  }

  const rawBox = `
    <div class="glass rounded-xl p-4 mt-3">
      <div class="flex items-center justify-between mb-2">
        <div class="font-bold">Debug JSON</div>
        <button id="btnToggleJson" class="glass px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-white/10">Mostra/Nascondi</button>
      </div>
      <pre id="jsonBox" class="hidden text-[11px] text-gray-300 overflow-auto max-h-80 bg-black/30 rounded-lg p-3"></pre>
    </div>
  `;

  return `
    <button id="btnBack" class="text-gray-300 hover:text-white text-sm mb-3">‚Üê Torna alla lista</button>

    <div class="glass rounded-2xl p-4 mb-3">
      <div class="flex items-center justify-between mb-2">
        <div class="text-xs text-cyan-300 font-medium">${escapeHtml(s.tournament || meta.label)}</div>
        <div class="text-xs text-gray-500">${escapeHtml(dt)}</div>
      </div>
      <div class="flex items-center justify-center gap-3">
        <div class="font-black text-white text-base">${escapeHtml(s.home)}</div>
        <div class="text-gray-400 font-bold">vs</div>
        <div class="font-black text-white text-base">${escapeHtml(s.away)}</div>
      </div>
      <div class="text-[11px] text-gray-500 text-center mt-2">Event ID: ${escapeHtml(String(s.id))}</div>
    </div>

    ${analysisHtml}
    ${rawBox}
  `;
}

function escapeHtml(s) {
  return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
}
function escapeAttr(s) { return escapeHtml(s).replace(/`/g, "&#096;"); }

function bindListClicks() {
  document.querySelectorAll(".match-card").forEach(el => {
    el.addEventListener("click", () => {
      const id = el.getAttribute("data-id");
      loadSelectedDetails(id);
    });
  });
}

function bindSelectedHandlers() {
  const back = document.getElementById("btnBack");
  if (back) back.addEventListener("click", () => {
    state.selected = null;
    state.error = null;
    setStatus("");
    render();
  });

  const toggle = document.getElementById("btnToggleJson");
  const box = document.getElementById("jsonBox");
  if (toggle && box) {
    toggle.addEventListener("click", () => {
      box.classList.toggle("hidden");
    });

    const payload = {
      event: state.selected?.rawEvent || null,
      stats: state.selected?.rawStats || null,
    };
    box.textContent = JSON.stringify(payload, null, 2);
  }
}

function render() {
  const content = document.getElementById("content");
  if (state.selected) {
    content.innerHTML = renderSelected();
    bindSelectedHandlers();
    return;
  }
  content.innerHTML = renderList();
  bindListClicks();
}

updateHeader();
updateSportButtons();
render();
</script>
</body>
</html>
