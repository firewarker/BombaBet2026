<!doctype html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BOMBA BET PRO - SportAPI7</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    * { font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body {
      min-height: 100vh;
      color: #e5e7eb;
      background:
        radial-gradient(800px 500px at 20% 15%, rgba(34,197,94,0.25), transparent 60%),
        radial-gradient(700px 450px at 80% 25%, rgba(6,182,212,0.25), transparent 60%),
        radial-gradient(700px 450px at 70% 80%, rgba(168,85,247,0.22), transparent 60%),
        radial-gradient(600px 400px at 15% 85%, rgba(249,115,22,0.18), transparent 60%),
        linear-gradient(135deg, #0b1020 0%, #020617 65%, #010409 100%);
      overflow-x: hidden;
    }
    .glass {
      background: rgba(15, 23, 42, 0.82);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(148,163,184,0.22);
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.6);
    }
    .glass2 {
      background: rgba(2, 6, 23, 0.55);
      backdrop-filter: blur(22px);
      border: 1px solid rgba(148,163,184,0.18);
    }
    .chip { border: 1px solid rgba(148,163,184,0.22); background: rgba(255,255,255,0.04); }
    .soft-border { border: 1px solid rgba(255,255,255,0.08); }
    .match-card { transition: transform .15s ease, background .15s ease; }
    .match-card:hover { transform: translateY(-2px); background: rgba(255,255,255,0.06); cursor: pointer; }
    .loader { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg);} to { transform: rotate(360deg);} }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .conf-high { color: #34d399; }
    .conf-mid  { color: #fbbf24; }
    .conf-low  { color: #fb7185; }

    .btn {
      border: 1px solid rgba(148,163,184,0.22);
      background: rgba(255,255,255,0.04);
      transition: transform .12s ease, background .12s ease, opacity .12s ease;
    }
    .btn:hover { background: rgba(255,255,255,0.08); transform: translateY(-1px); }
    .btn:disabled { opacity: .55; cursor: not-allowed; transform: none; }

    .grad-green { background-image: linear-gradient(135deg, rgba(34,197,94,1), rgba(6,182,212,1)); }
    .grad-orange { background-image: linear-gradient(135deg, rgba(249,115,22,1), rgba(245,158,11,1)); }
    .grad-purple { background-image: linear-gradient(135deg, rgba(168,85,247,1), rgba(236,72,153,1)); }

    .pulse {
      box-shadow: 0 0 0 0 rgba(6,182,212,0.55);
      animation: pulse 2.4s infinite;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(6,182,212,0.40); }
      70% { box-shadow: 0 0 0 18px rgba(6,182,212,0); }
      100% { box-shadow: 0 0 0 0 rgba(6,182,212,0); }
    }
  </style>
</head>

<body>
  <div class="max-w-6xl mx-auto min-h-screen flex flex-col">

    <!-- HEADER -->
    <header class="glass sticky top-0 z-50 border-b border-white/10">
      <div class="px-5 py-4 flex items-center justify-between gap-4">
        <div class="flex items-center gap-4 min-w-0">
          <div id="sportBadge" class="w-14 h-14 rounded-2xl grad-green flex items-center justify-center text-gray-900 font-black text-2xl pulse">
            ‚öΩ
          </div>
          <div class="min-w-0">
            <div class="text-2xl font-black tracking-tight text-white">BOMBA BET <span class="text-cyan-300">PRO</span></div>
            <div class="text-sm text-gray-300 truncate">SportAPI7 ‚Ä¢ GG + Corner/Cartellini ‚Ä¢ Storico & Hit-rate</div>
          </div>
        </div>

        <div class="flex items-center gap-2 flex-wrap justify-end">
          <div class="hidden md:flex items-center gap-2 px-3 py-2 rounded-xl glass2">
            <div class="text-xs text-gray-400">Hit</div>
            <div id="uiHit" class="text-sm font-black text-cyan-300">0%</div>
            <div class="w-px h-4 bg-white/10"></div>
            <div class="text-xs text-gray-400">Tot</div>
            <div id="uiTot" class="text-sm font-black text-white">0</div>
            <div class="w-px h-4 bg-white/10"></div>
            <div class="text-xs text-gray-400">V/P</div>
            <div id="uiWL" class="text-sm font-black text-white">0/0</div>
          </div>

          <button id="btnKey" class="btn px-4 py-2 rounded-xl text-sm font-bold">üîë Key</button>
          <button id="btnToggleSettings" class="btn px-4 py-2 rounded-xl text-sm font-bold">‚öôÔ∏è API</button>
          <button id="btnResetAll" class="btn px-4 py-2 rounded-xl text-sm font-bold text-orange-300">üóëÔ∏è Reset</button>
        </div>
      </div>

      <div class="px-5 pb-4">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
          <div class="glass2 rounded-2xl p-4">
            <div class="text-[11px] uppercase tracking-wider text-gray-400 font-bold">Sport</div>
            <div class="flex gap-2 mt-2 flex-wrap">
              <button class="sportBtn btn px-4 py-2 rounded-xl text-sm font-bold grad-green text-gray-900" data-sport="football">‚öΩ Calcio</button>
              <button class="sportBtn btn px-4 py-2 rounded-xl text-sm font-bold" data-sport="basketball">üèÄ Basket</button>
              <button class="sportBtn btn px-4 py-2 rounded-xl text-sm font-bold" data-sport="tennis">üéæ Tennis</button>
            </div>
            <div class="text-xs text-gray-400 mt-3">
              Nota: analisi avanzata disponibile solo per Calcio in questa versione.
            </div>
          </div>

          <div class="glass2 rounded-2xl p-4">
            <div class="text-[11px] uppercase tracking-wider text-gray-400 font-bold">Data & Caricamento</div>
            <div class="flex gap-2 mt-2 items-center">
              <input id="dateInput" type="date" class="w-full px-4 py-2 rounded-xl bg-black/20 soft-border text-sm focus:outline-none focus:ring-2 focus:ring-cyan-500/30">
              <button id="btnLoad" class="px-5 py-2 rounded-xl font-black text-sm text-gray-900 grad-green hover:opacity-95 transition btn">Carica</button>
            </div>
            <div id="statusLine" class="text-xs text-gray-400 mt-3"></div>
          </div>

          <div class="glass2 rounded-2xl p-4">
            <div class="text-[11px] uppercase tracking-wider text-gray-400 font-bold">Schermata</div>
            <div class="flex gap-2 mt-2">
              <button class="tabBtn btn px-4 py-2 rounded-xl text-sm font-bold grad-purple text-white" data-tab="matches">üìã Partite</button>
              <button class="tabBtn btn px-4 py-2 rounded-xl text-sm font-bold" data-tab="history">üìà Storico</button>
              <button class="tabBtn btn px-4 py-2 rounded-xl text-sm font-bold" data-tab="debug">üß™ Debug</button>
            </div>
            <div class="text-xs text-gray-400 mt-3">
              Lo storico salva i pronostici selezionati e ti fa segnare Vinta/Persa.
            </div>
          </div>
        </div>

        <!-- SETTINGS PANEL -->
        <div id="settingsPanel" class="hidden mt-3 glass2 rounded-2xl p-4">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="font-black text-white">Impostazioni SportAPI7</div>
              <div class="text-xs text-gray-400 mt-1">
                Host predefinito: <span class="mono text-cyan-300">sportapi7.p.rapidapi.com</span> e base <span class="mono text-cyan-300">/api/v1</span>.
              </div>
            </div>
            <button id="btnCloseSettings" class="btn px-3 py-2 rounded-xl text-sm font-bold">Chiudi</button>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-3 mt-4">
            <div class="glass rounded-2xl p-4">
              <div class="text-xs text-gray-400 font-bold uppercase tracking-wider">Endpoint lista eventi</div>
              <div class="text-xs text-gray-300 mt-2">
                Modifica solo se nel Playground RapidAPI il path √® diverso.
              </div>
              <input id="epScheduled" class="mt-3 w-full px-3 py-2 rounded-xl bg-black/30 soft-border text-xs mono"
                placeholder="/api/v1/sport/{sport}/scheduled-events/{YYYY-MM-DD}">
              <div class="text-[11px] text-gray-500 mt-2">
                Placeholder: <span class="mono">{sport}</span> e <span class="mono">{date}</span>
              </div>
            </div>

            <div class="glass rounded-2xl p-4">
              <div class="text-xs text-gray-400 font-bold uppercase tracking-wider">Endpoint evento</div>
              <input id="epEvent" class="mt-3 w-full px-3 py-2 rounded-xl bg-black/30 soft-border text-xs mono"
                placeholder="/api/v1/event/{id}">
              <div class="text-[11px] text-gray-500 mt-2">
                Placeholder: <span class="mono">{id}</span>
              </div>
            </div>

            <div class="glass rounded-2xl p-4">
              <div class="text-xs text-gray-400 font-bold uppercase tracking-wider">Endpoint statistiche (opz.)</div>
              <input id="epStats" class="mt-3 w-full px-3 py-2 rounded-xl bg-black/30 soft-border text-xs mono"
                placeholder="/api/v1/event/{id}/statistics">
              <div class="text-[11px] text-gray-500 mt-2">
                Se 404 non √® un problema: verr√† ignorato.
              </div>
            </div>
          </div>

          <div class="flex gap-2 mt-4 flex-wrap">
            <button id="btnSaveSettings" class="btn px-4 py-2 rounded-xl font-bold text-sm grad-green text-gray-900">Salva</button>
            <button id="btnRestoreSettings" class="btn px-4 py-2 rounded-xl font-bold text-sm">Ripristina default</button>
          </div>
        </div>
      </div>
    </header>

    <!-- CONTENT -->
    <main class="flex-1 p-5 pb-14">
      <div id="content"></div>
    </main>

    <footer class="px-5 pb-8 text-xs text-gray-500 text-center">
      <div>Anti-429 con throttle + retry (se presente usa anche Retry-After). [web:70]</div>
      <div>Storico e statistiche salvate nel browser tramite localStorage. [web:80]</div>
    </footer>
  </div>

<script>
/* ============================================================
   CONFIG + STORAGE KEYS
   ============================================================ */

const RAPIDAPI_HOST = "sportapi7.p.rapidapi.com"; // dallo screen [file:17]
const DEFAULT_ENDPOINTS = {
  scheduled: "/api/v1/sport/{sport}/scheduled-events/{date}",
  event: "/api/v1/event/{id}",
  stats: "/api/v1/event/{id}/statistics"
};

const LS = {
  KEY: "bb_rapidapi_key",
  SETTINGS: "bb_endpoints_v1",
  HISTORY: "bb_history_v1",
  CACHE: "bb_cache_v1:" // prefix
};

/* ============================================================
   SETTINGS (endpoints)
   ============================================================ */

function loadSettings() {
  try {
    const raw = localStorage.getItem(LS.SETTINGS);
    if (!raw) return { ...DEFAULT_ENDPOINTS };
    const obj = JSON.parse(raw);
    return {
      scheduled: obj?.scheduled || DEFAULT_ENDPOINTS.scheduled,
      event: obj?.event || DEFAULT_ENDPOINTS.event,
      stats: obj?.stats || DEFAULT_ENDPOINTS.stats
    };
  } catch {
    return { ...DEFAULT_ENDPOINTS };
  }
}

function saveSettings(s) {
  localStorage.setItem(LS.SETTINGS, JSON.stringify(s));
}

let endpoints = loadSettings();

/* ============================================================
   ANTI-429 + CACHE
   ============================================================ */

const MIN_GAP_MS = 650;
let _lastReqTs = 0;

async function throttle() {
  const now = Date.now();
  const wait = Math.max(0, MIN_GAP_MS - (now - _lastReqTs));
  if (wait > 0) await new Promise(r => setTimeout(r, wait));
  _lastReqTs = Date.now();
}

// Retry su 429: usa Retry-After se presente, altrimenti backoff esponenziale [web:70]
async function fetchWith429Retry(url, options, maxRetries = 4) {
  let last = null;
  for (let attempt = 0; attempt <= maxRetries; attempt++) {
    await throttle();
    const res = await fetch(url, options);
    last = res;

    if (res.status !== 429) return res;

    const ra = res.headers.get("retry-after");
    const retryAfterMs = ra ? (parseInt(ra, 10) * 1000) : 0;
    const backoffMs = Math.round(900 * Math.pow(2, attempt)); // 0.9s, 1.8s, 3.6s...
    const sleepMs = retryAfterMs > 0 ? retryAfterMs : backoffMs;
    setStatus(`429: attendo ${Math.max(1, Math.round(sleepMs/1000))}s e riprovo...`);
    await new Promise(r => setTimeout(r, sleepMs));
  }
  return last;
}

const CACHE_TTL_MS = 60 * 1000;

function cacheGet(url) {
  try {
    const raw = localStorage.getItem(LS.CACHE + url);
    if (!raw) return null;
    const obj = JSON.parse(raw);
    if (!obj?.t) return null;
    if ((Date.now() - obj.t) > CACHE_TTL_MS) return null;
    return obj.v;
  } catch { return null; }
}

function cacheSet(url, data) {
  try {
    localStorage.setItem(LS.CACHE + url, JSON.stringify({ t: Date.now(), v: data }));
  } catch {}
}

function clearCache() {
  try {
    const keys = Object.keys(localStorage);
    keys.forEach(k => { if (k.startsWith(LS.CACHE)) localStorage.removeItem(k); });
  } catch {}
}

/* ============================================================
   API KEY
   ============================================================ */

let RAPIDAPI_KEY = localStorage.getItem(LS.KEY) || "";

function promptKey() {
  const k = prompt("Incolla la tua RapidAPI Key (salvata nel browser):", RAPIDAPI_KEY || "");
  if (!k) return;
  RAPIDAPI_KEY = k.trim();
  localStorage.setItem(LS.KEY, RAPIDAPI_KEY);
  setStatus("Key salvata.");
}

async function apiGet(path) {
  if (!RAPIDAPI_KEY) throw new Error("RapidAPI Key mancante: clicca üîë Key.");
  const url = `https://${RAPIDAPI_HOST}${path}`;

  const cached = cacheGet(url);
  if (cached) return cached;

  const res = await fetchWith429Retry(url, {
    method: "GET",
    headers: {
      "X-RapidAPI-Key": RAPIDAPI_KEY,
      "X-RapidAPI-Host": RAPIDAPI_HOST
    }
  });

  if (!res?.ok) {
    let extra = "";
    try { extra = (await res.text() || "").slice(0, 240); } catch {}
    throw new Error(`HTTP ${res ? res.status : "?"}${extra ? " - " + extra : ""}`);
  }

  const data = await res.json();
  cacheSet(url, data);
  return data;
}

/* ============================================================
   STATE
   ============================================================ */

const sportMeta = {
  football: { badge: "‚öΩ", grad: "grad-green", label: "Calcio" },
  basketball: { badge: "üèÄ", grad: "grad-orange", label: "Basket" },
  tennis: { badge: "üéæ", grad: "grad-purple", label: "Tennis" },
};

const state = {
  sport: "football",
  tab: "matches", // matches | history | debug
  date: new Date().toISOString().slice(0, 10),
  loading: false,
  error: null,
  matches: [],
  selected: null,
  lastRaw: null, // per debug
  history: []
};

function setStatus(msg) {
  document.getElementById("statusLine").textContent = msg || "";
}

/* ============================================================
   HISTORY (localStorage) [web:80]
   ============================================================ */

function loadHistory() {
  try {
    const raw = localStorage.getItem(LS.HISTORY);
    const arr = raw ? JSON.parse(raw) : [];
    return Array.isArray(arr) ? arr : [];
  } catch { return []; }
}

function saveHistory() {
  localStorage.setItem(LS.HISTORY, JSON.stringify(state.history));
  refreshHeaderStats();
}

function addPick(pick) {
  state.history.unshift(pick);
  saveHistory();
}

function updatePickResult(id, result) {
  const p = state.history.find(x => x.id === id);
  if (!p) return;
  p.result = result; // "won" | "lost" | null
  saveHistory();
  render();
}

function statsFromHistory() {
  const total = state.history.length;
  const resolved = state.history.filter(x => x.result === "won" || x.result === "lost");
  const won = resolved.filter(x => x.result === "won").length;
  const lost = resolved.filter(x => x.result === "lost").length;
  const hit = resolved.length ? ((won / resolved.length) * 100) : 0;
  return { total, won, lost, hit: hit.toFixed(1), resolved: resolved.length };
}

function refreshHeaderStats() {
  const s = statsFromHistory();
  document.getElementById("uiHit").textContent = `${s.hit}%`;
  document.getElementById("uiTot").textContent = `${s.total}`;
  document.getElementById("uiWL").textContent = `${s.won}/${s.lost}`;
}

/* ============================================================
   ENDPOINT HELPERS
   ============================================================ */

function fillPath(template, vars) {
  return template
    .replaceAll("{sport}", vars.sport)
    .replaceAll("{date}", vars.date)
    .replaceAll("{id}", vars.id);
}

/* ============================================================
   DATA NORMALIZATION
   ============================================================ */

function normalizeEventsResponse(data) {
  // sportapi7 spesso usa { events: [...] } (stile Sofascore)
  // fallback: prova altri campi comuni.
  const events = data?.events || data?.response || data?.data || data?.results || [];
  return Array.isArray(events) ? events : [];
}

function toMatchModel(ev) {
  const id = ev?.id ?? ev?.event?.id ?? ev?.fixture?.id ?? null;
  const startTs = ev?.startTimestamp ?? ev?.startTime ?? ev?.fixture?.timestamp ?? null;

  const tournament =
    ev?.tournament?.name ||
    ev?.league?.name ||
    ev?.competition?.name ||
    ev?.category?.name ||
    ev?.tournament?.category?.name ||
    "‚Äî";

  const home =
    ev?.homeTeam?.name ||
    ev?.home?.name ||
    ev?.teams?.home?.name ||
    ev?.player1?.name ||
    ev?.homePlayer?.name ||
    "Home";

  const away =
    ev?.awayTeam?.name ||
    ev?.away?.name ||
    ev?.teams?.away?.name ||
    ev?.player2?.name ||
    ev?.awayPlayer?.name ||
    "Away";

  const homeLogo =
    ev?.homeTeam?.logo || ev?.home?.logo || ev?.teams?.home?.logo || null;

  const awayLogo =
    ev?.awayTeam?.logo || ev?.away?.logo || ev?.teams?.away?.logo || null;

  return { id, startTs, tournament, home, away, homeLogo, awayLogo, raw: ev };
}

function fmtDate(tsSeconds) {
  try {
    if (!tsSeconds) return "--";
    const d = new Date(tsSeconds * 1000);
    return d.toLocaleString("it-IT", { weekday:"short", day:"2-digit", month:"2-digit", hour:"2-digit", minute:"2-digit" });
  } catch { return "--"; }
}

function confClass(v) {
  if (v >= 65) return "conf-high";
  if (v >= 52) return "conf-mid";
  return "conf-low";
}

/* ============================================================
   ANALYSIS (Calcio) ‚Äî SOLO: GG + Corner (Tot, Home, Away) + Cards (Tot, Home, Away)
   ============================================================ */

// Mini database (puoi estenderlo)
const TEAMSTATS = {
  "Juventus": { corners: 5.8, cornersAg: 4.2, cards: 2.1, cardsAg: 1.8, gf: 1.8, ga: 0.9, ggRate: 48 },
  "Inter":    { corners: 6.2, cornersAg: 3.8, cards: 1.9, cardsAg: 2.0, gf: 2.4, ga: 0.8, ggRate: 52 },
  "Milan":    { corners: 5.5, cornersAg: 4.5, cards: 2.3, cardsAg: 1.9, gf: 2.1, ga: 1.1, ggRate: 58 },
  "Roma":     { corners: 5.3, cornersAg: 4.8, cards: 2.4, cardsAg: 2.0, gf: 1.6, ga: 1.2, ggRate: 52 },
  "Napoli":   { corners: 5.9, cornersAg: 4.0, cards: 2.0, cardsAg: 2.1, gf: 2.2, ga: 1.0, ggRate: 55 },
};

function getTeamStats(name) {
  if (!name) return { corners: 5.0, cornersAg: 5.0, cards: 2.0, cardsAg: 2.0, gf: 1.3, ga: 1.3, ggRate: 50 };
  const n = name.toLowerCase();
  for (const [k, v] of Object.entries(TEAMSTATS)) {
    const kk = k.toLowerCase();
    if (n.includes(kk) || kk.includes(n)) return v;
  }
  return { corners: 5.0, cornersAg: 5.0, cards: 2.0, cardsAg: 2.0, gf: 1.3, ga: 1.3, ggRate: 50 };
}

function ouLines(lines, exp, baseConf, scale=10) {
  return lines.map(line => {
    const pick = exp > line ? "OVER" : "UNDER";
    const conf = Math.min(85, baseConf + Math.abs(exp - line) * scale);
    return { line, pick, conf };
  });
}

function analyzeFootballMatch(home, away) {
  const h = getTeamStats(home);
  const a = getTeamStats(away);

  // GG (stimato)
  const homeScoreProb = Math.min(95, (h.gf / 2.5) * 100);
  const awayScoreProb = Math.min(95, (a.gf / 2.5) * 100);
  const avgGGRate = (h.ggRate + a.ggRate) / 2;
  let ggProb = (homeScoreProb * awayScoreProb / 100) * 0.5 + avgGGRate * 0.5;
  ggProb = Math.max(25, Math.min(78, ggProb));

  // Corner stimati (home/away/total)
  const homeCornersExp = (h.corners * 1.08 + a.cornersAg * 0.92) / 2;
  const awayCornersExp = (a.corners * 0.92 + h.cornersAg * 1.08) / 2;
  const totalCornersExp = homeCornersExp + awayCornersExp;

  // Cartellini stimati (home/away/total)
  const homeCardsExp = (h.cards * 0.92 + a.cardsAg * 1.08) / 2;
  const awayCardsExp = (a.cards * 1.05 + h.cardsAg * 0.95) / 2;
  const totalCardsExp = homeCardsExp + awayCardsExp;

  return {
    gg: {
      pick: ggProb >= 52 ? "GG" : "NG",
      prob: ggProb,
      conf: 45 + Math.abs(ggProb - 50) * 0.8
    },
    corners: {
      total: { exp: totalCornersExp, lines: ouLines([8.5, 9.5, 10.5, 11.5], totalCornersExp, 50, 9) },
      home:  { exp: homeCornersExp,  lines: ouLines([3.5, 4.5, 5.5, 6.5],  homeCornersExp,  48, 11) },
      away:  { exp: awayCornersExp,  lines: ouLines([3.5, 4.5, 5.5, 6.5],  awayCornersExp,  48, 11) }
    },
    cards: {
      total: { exp: totalCardsExp, lines: ouLines([3.5, 4.5, 5.5], totalCardsExp, 48, 11) },
      home:  { exp: homeCardsExp,  lines: ouLines([1.5, 2.5, 3.5], homeCardsExp,  46, 12) },
      away:  { exp: awayCardsExp,  lines: ouLines([1.5, 2.5, 3.5], awayCardsExp,  46, 12) }
    }
  };
}

/* ============================================================
   LOAD MATCHES + ORDER CHRONOLOGICAL [web:60]
   ============================================================ */

async function loadMatches() {
  if (state.loading) return;
  state.loading = true;
  state.error = null;
  state.matches = [];
  state.selected = null;
  setStatus("Caricamento eventi...");
  render();

  try {
    const path = fillPath(endpoints.scheduled, { sport: state.sport, date: state.date });
    const data = await apiGet(path);
    state.lastRaw = data;

    const events = normalizeEventsResponse(data);
    state.matches = events.map(toMatchModel);

    // ordine cronologico crescente [web:60]
    state.matches.sort((a, b) => (a.startTs || 0) - (b.startTs || 0));

    if (!state.matches.length) {
      state.error = "Nessun evento trovato. Verifica endpoint/abbonamento nel Playground RapidAPI.";
    } else {
      setStatus(`Trovati ${state.matches.length} eventi.`);
    }
  } catch (e) {
    state.error = e?.message || String(e);
    setStatus("");
  } finally {
    state.loading = false;
    render();
  }
}

/* ============================================================
   LOAD EVENT DETAILS (opzionale)
   ============================================================ */

async function loadEventDetails(eventId) {
  if (state.loading) return;
  state.loading = true;
  state.error = null;
  setStatus("Caricamento evento...");
  render();

  const base = state.matches.find(m => String(m.id) === String(eventId));

  try {
    const pEvent = fillPath(endpoints.event, { id: eventId });
    const pStats = fillPath(endpoints.stats, { id: eventId });

    const [evRes, stRes] = await Promise.allSettled([
      apiGet(pEvent),
      apiGet(pStats)
    ]);

    const ev = (evRes.status === "fulfilled") ? evRes.value : null;
    const st = (stRes.status === "fulfilled") ? stRes.value : null;

    state.selected = {
      id: eventId,
      base,
      ev,
      st,
      // tenta di prendere info migliori dall'evento dettagliato
      home: ev?.event?.homeTeam?.name || ev?.homeTeam?.name || base?.home || "Home",
      away: ev?.event?.awayTeam?.name || ev?.awayTeam?.name || base?.away || "Away",
      tournament: ev?.event?.tournament?.name || ev?.tournament?.name || base?.tournament || "‚Äî",
      startTs: ev?.event?.startTimestamp || ev?.startTimestamp || base?.startTs || null
    };

    setStatus("Evento pronto.");
  } catch (e) {
    state.error = e?.message || String(e);
    state.selected = null;
    setStatus("");
  } finally {
    state.loading = false;
    render();
  }
}

/* ============================================================
   UI RENDER
   ============================================================ */

function escapeHtml(s) {
  return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
}
function escapeAttr(s) { return escapeHtml(s).replace(/`/g, "&#096;"); }

function renderLoadingCard(msg="Caricamento...") {
  return `
    <div class="glass rounded-2xl p-8 text-center">
      <div class="w-12 h-12 border-4 border-cyan-400 border-t-transparent rounded-full loader mx-auto mb-4"></div>
      <div class="text-gray-300 font-bold">${escapeHtml(msg)}</div>
      <div class="text-xs text-gray-500 mt-2">Se ricevi 429, attendi e riprova.</div>
    </div>
  `;
}

function renderErrorCard(err) {
  return `
    <div class="glass rounded-2xl p-6">
      <div class="text-red-300 font-black mb-2">Errore</div>
      <div class="text-sm text-red-200 mono whitespace-pre-wrap">${escapeHtml(err)}</div>
      <div class="text-xs text-gray-400 mt-3">
        Suggerimento: se √® 404 o ‚ÄúNessun evento‚Äù, controlla gli endpoint nella sezione ‚öôÔ∏è API.
      </div>
    </div>
  `;
}

function renderMatchesList() {
  const meta = sportMeta[state.sport];

  let top = `
    <div class="flex items-center justify-between gap-3">
      <div class="flex items-center gap-2">
        <div class="chip px-3 py-1 rounded-full text-xs font-bold">${meta.label}</div>
        <div class="chip px-3 py-1 rounded-full text-xs font-bold text-cyan-200">${escapeHtml(state.date)}</div>
      </div>
      <div class="text-xs text-gray-400">${state.matches.length ? `${state.matches.length} eventi` : ""}</div>
    </div>
  `;

  if (state.loading) return top + renderLoadingCard();
  if (state.error) return top + renderErrorCard(state.error);
  if (!state.matches.length) {
    return top + `
      <div class="glass rounded-2xl p-8 text-center">
        <div class="text-gray-300 font-bold mb-2">Nessun evento caricato</div>
        <div class="text-xs text-gray-500">Seleziona una data e premi ‚ÄúCarica‚Äù.</div>
      </div>
    `;
  }

  let list = `<div class="grid grid-cols-1 lg:grid-cols-2 gap-3">`;
  state.matches.forEach((m, i) => {
    list += `
      <div class="glass rounded-2xl p-4 match-card" data-id="${escapeHtml(String(m.id ?? i))}">
        <div class="flex items-center justify-between mb-2">
          <div class="text-xs text-cyan-200 font-bold truncate pr-2">${escapeHtml(m.tournament)}</div>
          <div class="text-xs text-gray-400">${escapeHtml(fmtDate(m.startTs))}</div>
        </div>

        <div class="flex items-center justify-between gap-3">
          <div class="flex items-center gap-2 min-w-0 flex-1">
            ${m.homeLogo ? `<img class="w-8 h-8 rounded-lg" src="${escapeAttr(m.homeLogo)}">` : `<div class="w-8 h-8 rounded-lg bg-white/5"></div>`}
            <div class="font-black text-white truncate">${escapeHtml(m.home)}</div>
          </div>
          <div class="text-gray-400 font-bold">vs</div>
          <div class="flex items-center gap-2 min-w-0 flex-1 justify-end">
            <div class="font-black text-white truncate text-right">${escapeHtml(m.away)}</div>
            ${m.awayLogo ? `<img class="w-8 h-8 rounded-lg" src="${escapeAttr(m.awayLogo)}">` : `<div class="w-8 h-8 rounded-lg bg-white/5"></div>`}
          </div>
        </div>

        <div class="mt-3 flex items-center justify-between">
          <div class="text-[11px] text-gray-400 mono">ID: ${escapeHtml(String(m.id ?? "n/a"))}</div>
          <div class="text-[11px] text-emerald-300 font-bold">Clicca per analisi ‚Üí</div>
        </div>
      </div>
    `;
  });
  list += `</div>`;
  return top + list;
}

function pickTemplate({ type, side, market, line, pick, conf, match }) {
  return {
    id: Date.now() + Math.floor(Math.random() * 9999),
    createdAt: new Date().toISOString(),
    sport: state.sport,
    eventId: String(match.id ?? ""),
    eventTime: match.startTs || null,
    teams: `${match.home} vs ${match.away}`,
    tournament: match.tournament,
    date: state.date,
    type,      // "GG" | "Corners" | "Cards"
    market,    // es: "Totale" | "Casa" | "Ospite"
    side,      // "Total" | "Home" | "Away"
    line,      // number or null
    pick,      // "GG" | "NG" | "OVER" | "UNDER"
    conf: Math.round(conf),
    result: null // won | lost | null
  };
}

function renderPickRow(match, type, marketLabel, side, lineObj) {
  const pick = lineObj.pick;
  const conf = lineObj.conf;
  const cl = confClass(conf);

  const label = `${type} ${marketLabel}`;
  const btnText = `${pick} ${lineObj.line}`;

  return `
    <div class="flex items-center justify-between gap-2 bg-black/30 rounded-xl p-3 soft-border">
      <div class="min-w-0">
        <div class="text-sm font-bold text-white truncate">${escapeHtml(label)}</div>
        <div class="text-xs text-gray-400">Linea: <span class="mono">${lineObj.line}</span></div>
      </div>

      <div class="flex items-center gap-2">
        <div class="text-sm font-black ${cl}">${lineObj.conf.toFixed(0)}</div>
        <button class="btnPick px-3 py-2 rounded-xl text-xs font-black text-gray-900 grad-green" 
          data-type="${escapeHtml(type)}"
          data-market="${escapeHtml(marketLabel)}"
          data-side="${escapeHtml(side)}"
          data-line="${escapeHtml(String(lineObj.line))}"
          data-pick="${escapeHtml(pick)}"
          data-conf="${escapeHtml(String(conf))}">
          Salva
        </button>
      </div>
    </div>
  `;
}

function renderSelected() {
  const s = state.selected;
  const m = {
    id: s.id,
    home: s.home,
    away: s.away,
    tournament: s.tournament,
    startTs: s.startTs,
    homeLogo: s.base?.homeLogo || null,
    awayLogo: s.base?.awayLogo || null
  };

  const header = `
    <div class="flex items-center justify-between gap-3">
      <button id="btnBack" class="btn px-4 py-2 rounded-xl text-sm font-bold">‚Üê Indietro</button>
      <div class="chip px-3 py-1 rounded-full text-xs font-bold text-cyan-200">${escapeHtml(fmtDate(m.startTs))}</div>
    </div>

    <div class="glass rounded-2xl p-5">
      <div class="flex items-center justify-between mb-2">
        <div class="text-xs text-cyan-200 font-bold">${escapeHtml(m.tournament)}</div>
        <div class="text-xs text-gray-400 mono">ID: ${escapeHtml(String(m.id))}</div>
      </div>

      <div class="flex items-center justify-center gap-3">
        <div class="flex items-center gap-2 min-w-0">
          ${m.homeLogo ? `<img class="w-10 h-10 rounded-xl" src="${escapeAttr(m.homeLogo)}">` : `<div class="w-10 h-10 rounded-xl bg-white/5"></div>`}
          <div class="font-black text-white text-lg truncate">${escapeHtml(m.home)}</div>
        </div>
        <div class="text-gray-400 font-black text-xl">vs</div>
        <div class="flex items-center gap-2 min-w-0">
          <div class="font-black text-white text-lg truncate text-right">${escapeHtml(m.away)}</div>
          ${m.awayLogo ? `<img class="w-10 h-10 rounded-xl" src="${escapeAttr(m.awayLogo)}">` : `<div class="w-10 h-10 rounded-xl bg-white/5"></div>`}
        </div>
      </div>
    </div>
  `;

  if (state.sport !== "football") {
    return header + `
      <div class="glass rounded-2xl p-5">
        <div class="font-black text-white mb-2">Analisi non disponibile</div>
        <div class="text-sm text-gray-300">In questa versione l‚Äôanalisi √® implementata solo per Calcio.</div>
        <div class="text-xs text-gray-500 mt-2">Puoi comunque salvare un pick manuale dallo Storico (prossimo step, se vuoi).</div>
      </div>
    `;
  }

  const a = analyzeFootballMatch(m.home, m.away);

  const ggBox = `
    <div class="glass rounded-2xl p-5">
      <div class="flex items-center justify-between">
        <div class="font-black text-white">Segno</div>
        <div class="chip px-3 py-1 rounded-full text-xs font-bold">Solo GG</div>
      </div>

      <div class="grid grid-cols-2 gap-3 mt-4">
        <div class="bg-black/30 rounded-2xl p-4 soft-border text-center ${a.gg.pick === "GG" ? "ring-2 ring-emerald-500/60" : ""}">
          <div class="text-2xl font-black text-white">GG</div>
          <div class="text-xs text-gray-400 mt-1">Prob</div>
          <div class="text-lg font-black ${confClass(a.gg.conf)}">${a.gg.prob.toFixed(0)}%</div>
          <button class="btnPick mt-3 w-full px-3 py-2 rounded-xl text-xs font-black text-gray-900 grad-green"
            data-type="GG" data-market="Segno" data-side="Total" data-line="" data-pick="GG" data-conf="${escapeAttr(String(a.gg.conf))}">
            Salva GG
          </button>
        </div>

        <div class="bg-black/30 rounded-2xl p-4 soft-border text-center ${a.gg.pick === "NG" ? "ring-2 ring-rose-500/60" : ""}">
          <div class="text-2xl font-black text-white">NG</div>
          <div class="text-xs text-gray-400 mt-1">Prob</div>
          <div class="text-lg font-black ${confClass(100 - a.gg.conf)}">${(100 - a.gg.prob).toFixed(0)}%</div>
          <button class="btnPick mt-3 w-full px-3 py-2 rounded-xl text-xs font-black text-gray-900 grad-orange"
            data-type="GG" data-market="Segno" data-side="Total" data-line="" data-pick="NG" data-conf="${escapeAttr(String(100 - a.gg.conf))}">
            Salva NG
          </button>
        </div>
      </div>
    </div>
  `;

  function block(title, subtitle, exp, rowsHtml) {
    return `
      <div class="glass rounded-2xl p-5">
        <div class="flex items-end justify-between gap-2">
          <div>
            <div class="font-black text-white">${escapeHtml(title)}</div>
            <div class="text-xs text-gray-400 mt-1">${escapeHtml(subtitle)}</div>
          </div>
          <div class="chip px-3 py-1 rounded-full text-xs font-bold text-cyan-200">Exp <span class="mono">${exp.toFixed(1)}</span></div>
        </div>
        <div class="space-y-2 mt-4">${rowsHtml}</div>
      </div>
    `;
  }

  // Corner rows
  const cornersTotalRows = a.corners.total.lines.map(l => renderPickRow(m, "Corners", "Totale", "Total", l)).join("");
  const cornersHomeRows  = a.corners.home.lines.map(l => renderPickRow(m, "Corners", "Casa", "Home", l)).join("");
  const cornersAwayRows  = a.corners.away.lines.map(l => renderPickRow(m, "Corners", "Ospite", "Away", l)).join("");

  // Cards rows
  const cardsTotalRows = a.cards.total.lines.map(l => renderPickRow(m, "Cards", "Totale", "Total", l)).join("");
  const cardsHomeRows  = a.cards.home.lines.map(l => renderPickRow(m, "Cards", "Casa", "Home", l)).join("");
  const cardsAwayRows  = a.cards.away.lines.map(l => renderPickRow(m, "Cards", "Ospite", "Away", l)).join("");

  const cornerBlocks = `
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
      ${block("Corner", "Over/Under Totale", a.corners.total.exp, cornersTotalRows)}
      ${block("Corner", "Over/Under Casa", a.corners.home.exp, cornersHomeRows)}
      ${block("Corner", "Over/Under Ospite", a.corners.away.exp, cornersAwayRows)}
    </div>
  `;

  const cardBlocks = `
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
      ${block("Cartellini", "Over/Under Totale", a.cards.total.exp, cardsTotalRows)}
      ${block("Cartellini", "Over/Under Casa", a.cards.home.exp, cardsHomeRows)}
      ${block("Cartellini", "Over/Under Ospite", a.cards.away.exp, cardsAwayRows)}
    </div>
  `;

  return header + ggBox + cornerBlocks + cardBlocks;
}

function renderHistory() {
  const s = statsFromHistory();

  if (!state.history.length) {
    return `
      <div class="glass rounded-2xl p-8 text-center">
        <div class="text-white font-black text-lg mb-2">Storico vuoto</div>
        <div class="text-xs text-gray-500">Apri una partita e salva un pronostico: apparir√† qui.</div>
      </div>
    `;
  }

  const cards = `
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
      <div class="glass rounded-2xl p-4">
        <div class="text-xs text-gray-400 uppercase font-bold">Totali</div>
        <div class="text-3xl font-black text-white mt-1">${s.total}</div>
      </div>
      <div class="glass rounded-2xl p-4">
        <div class="text-xs text-gray-400 uppercase font-bold">Risolti</div>
        <div class="text-3xl font-black text-white mt-1">${s.resolved}</div>
      </div>
      <div class="glass rounded-2xl p-4">
        <div class="text-xs text-gray-400 uppercase font-bold">Vinti</div>
        <div class="text-3xl font-black text-emerald-300 mt-1">${s.won}</div>
      </div>
      <div class="glass rounded-2xl p-4">
        <div class="text-xs text-gray-400 uppercase font-bold">Hit-rate</div>
        <div class="text-3xl font-black text-cyan-300 mt-1">${s.hit}%</div>
      </div>
    </div>
  `;

  let list = `<div class="glass rounded-2xl p-4 mt-3">
    <div class="flex items-center justify-between mb-3">
      <div class="font-black text-white">Ultimi pronostici</div>
      <button id="btnClearHistory" class="btn px-3 py-2 rounded-xl text-xs font-bold text-rose-300">Svuota storico</button>
    </div>
    <div class="space-y-2">`;

  state.history.slice(0, 60).forEach(p => {
    const resultBadge =
      p.result === "won" ? `<span class="chip px-2 py-1 rounded-full text-[11px] font-black text-emerald-300">VINTA</span>` :
      p.result === "lost" ? `<span class="chip px-2 py-1 rounded-full text-[11px] font-black text-rose-300">PERSA</span>` :
      `<span class="chip px-2 py-1 rounded-full text-[11px] font-black text-gray-300">APERTO</span>`;

    const lineText = (p.line === "" || p.line == null) ? "" : ` ${p.line}`;
    const pickText = `${p.pick}${lineText}`;

    list += `
      <div class="bg-black/30 rounded-2xl p-3 soft-border">
        <div class="flex items-start justify-between gap-2">
          <div class="min-w-0">
            <div class="text-sm font-black text-white truncate">${escapeHtml(p.teams)}</div>
            <div class="text-[11px] text-gray-400 truncate">${escapeHtml(p.tournament || "‚Äî")} ‚Ä¢ ${escapeHtml(p.date || "")}</div>
          </div>
          <div class="flex items-center gap-2">
            ${resultBadge}
            <span class="chip px-2 py-1 rounded-full text-[11px] font-black ${confClass(p.conf)}">C ${p.conf}</span>
          </div>
        </div>

        <div class="flex items-center justify-between mt-2 gap-2 flex-wrap">
          <div class="text-xs text-gray-300">
            <span class="chip px-2 py-1 rounded-full text-[11px] font-black">${escapeHtml(p.type)}</span>
            <span class="chip px-2 py-1 rounded-full text-[11px] font-black">${escapeHtml(p.market)}</span>
            <span class="chip px-2 py-1 rounded-full text-[11px] font-black text-cyan-200">${escapeHtml(pickText)}</span>
          </div>

          <div class="flex gap-2">
            <button class="btnResult btn px-3 py-2 rounded-xl text-xs font-black text-gray-900 grad-green" data-id="${p.id}" data-result="won">‚úÖ Vinta</button>
            <button class="btnResult btn px-3 py-2 rounded-xl text-xs font-black text-gray-900 grad-orange" data-id="${p.id}" data-result="lost">‚ùå Persa</button>
            <button class="btnResult btn px-3 py-2 rounded-xl text-xs font-black" data-id="${p.id}" data-result="null">‚Ü©Ô∏é Reset</button>
          </div>
        </div>
      </div>
    `;
  });

  list += `</div></div>`;
  return cards + list;
}

function renderDebug() {
  const raw = state.lastRaw || null;
  const selected = state.selected ? { ev: state.selected.ev, st: state.selected.st } : null;

  return `
    <div class="glass rounded-2xl p-5">
      <div class="font-black text-white mb-2">Debug JSON</div>
      <div class="text-xs text-gray-400">Qui puoi vedere la risposta dell‚Äôendpoint eventi e l‚Äôeventuale dettaglio evento/statistiche.</div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 mt-4">
        <div class="bg-black/30 rounded-2xl p-4 soft-border">
          <div class="text-xs font-bold text-cyan-200 mb-2">Ultima lista eventi</div>
          <pre class="mono text-[11px] text-gray-200 overflow-auto max-h-96 whitespace-pre-wrap">${escapeHtml(JSON.stringify(raw, null, 2) || "null")}</pre>
        </div>
        <div class="bg-black/30 rounded-2xl p-4 soft-border">
          <div class="text-xs font-bold text-cyan-200 mb-2">Evento selezionato (se presente)</div>
          <pre class="mono text-[11px] text-gray-200 overflow-auto max-h-96 whitespace-pre-wrap">${escapeHtml(JSON.stringify(selected, null, 2) || "null")}</pre>
        </div>
      </div>
    </div>
  `;
}

function render() {
  const root = document.getElementById("content");

  if (state.tab === "history") {
    root.innerHTML = renderHistory();
    bindHistoryEvents();
    return;
  }

  if (state.tab === "debug") {
    root.innerHTML = renderDebug();
    return;
  }

  // matches tab
  if (state.selected) {
    root.innerHTML = renderSelected();
    bindSelectedEvents();
    return;
  }

  root.innerHTML = renderMatchesList();
  bindMatchClicks();
}

/* ============================================================
   BIND EVENTS
   ============================================================ */

function bindMatchClicks() {
  document.querySelectorAll(".match-card").forEach(card => {
    card.addEventListener("click", () => {
      const id = card.getAttribute("data-id");
      // se non c'√® id vero, prova ad aprire comunque l'analisi dai dati base
      const m = state.matches.find(x => String(x.id) === String(id));
      if (!m) return;

      // carica dettagli (se endpoint valido); in caso d'errore user√† comunque base
      loadEventDetails(m.id).catch(() => {});
    });
  });
}

function bindSelectedEvents() {
  const back = document.getElementById("btnBack");
  if (back) back.addEventListener("click", () => {
    state.selected = null;
    state.error = null;
    setStatus("");
    render();
  });

  document.querySelectorAll(".btnPick").forEach(btn => {
    btn.addEventListener("click", () => {
      const type = btn.getAttribute("data-type");
      const market = btn.getAttribute("data-market");
      const side = btn.getAttribute("data-side");
      const line = btn.getAttribute("data-line") || "";
      const pick = btn.getAttribute("data-pick");
      const conf = parseFloat(btn.getAttribute("data-conf") || "50");

      const match = {
        id: state.selected.id,
        home: state.selected.home,
        away: state.selected.away,
        tournament: state.selected.tournament,
        startTs: state.selected.startTs
      };

      const entry = pickTemplate({ type, market, side, line, pick, conf, match });
      addPick(entry);

      setStatus("Pronostico salvato nello storico.");
      refreshHeaderStats();
      render();
    });
  });
}

function bindHistoryEvents() {
  const btnClear = document.getElementById("btnClearHistory");
  if (btnClear) {
    btnClear.addEventListener("click", () => {
      if (!confirm("Svuotare tutto lo storico?")) return;
      state.history = [];
      saveHistory();
      render();
    });
  }

  document.querySelectorAll(".btnResult").forEach(btn => {
    btn.addEventListener("click", () => {
      const id = parseInt(btn.getAttribute("data-id"), 10);
      const r = btn.getAttribute("data-result");
      updatePickResult(id, r === "null" ? null : r);
    });
  });
}

/* ============================================================
   HEADER BUTTONS / TABS / SETTINGS
   ============================================================ */

function setActiveSportButtons() {
  document.querySelectorAll(".sportBtn").forEach(b => {
    const s = b.getAttribute("data-sport");
    const isOn = s === state.sport;
    b.classList.remove("grad-green", "grad-orange", "grad-purple", "text-gray-900", "text-white");
    if (isOn) {
      b.classList.add(sportMeta[s].grad);
      b.classList.add("text-gray-900");
    } else {
      b.classList.add("text-white");
    }
  });

  const badge = document.getElementById("sportBadge");
  badge.className = `w-14 h-14 rounded-2xl ${sportMeta[state.sport].grad} flex items-center justify-center text-gray-900 font-black text-2xl pulse`;
  badge.textContent = sportMeta[state.sport].badge;
}

function setActiveTabButtons() {
  document.querySelectorAll(".tabBtn").forEach(b => {
    const t = b.getAttribute("data-tab");
    b.classList.remove("grad-purple", "text-white");
    if (t === state.tab) {
      b.classList.add("grad-purple", "text-white");
    }
  });
}

function toggleSettings(show) {
  const panel = document.getElementById("settingsPanel");
  if (typeof show === "boolean") {
    panel.classList.toggle("hidden", !show);
  } else {
    panel.classList.toggle("hidden");
  }
}

function populateSettingsInputs() {
  document.getElementById("epScheduled").value = endpoints.scheduled;
  document.getElementById("epEvent").value = endpoints.event;
  document.getElementById("epStats").value = endpoints.stats;
}

function applySettingsFromInputs() {
  endpoints = {
    scheduled: document.getElementById("epScheduled").value.trim() || DEFAULT_ENDPOINTS.scheduled,
    event: document.getElementById("epEvent").value.trim() || DEFAULT_ENDPOINTS.event,
    stats: document.getElementById("epStats").value.trim() || DEFAULT_ENDPOINTS.stats,
  };
  saveSettings(endpoints);
}

document.getElementById("btnKey").addEventListener("click", promptKey);

document.getElementById("btnToggleSettings").addEventListener("click", () => {
  populateSettingsInputs();
  toggleSettings();
});

document.getElementById("btnCloseSettings").addEventListener("click", () => toggleSettings(false));

document
