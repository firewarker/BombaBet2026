<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>üéØ BOMBA BET PRO V2</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
    
    <style>
        * { font-family: 'Inter', system-ui, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%); min-height: 100vh; color: white; }
        
        .glass { background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); }
        .glass-light { background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.08); }
        .gradient-primary { background: linear-gradient(135deg, #10b981, #06b6d4); }
        .gradient-text { background: linear-gradient(135deg, #10b981, #06b6d4); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .glow { box-shadow: 0 0 40px rgba(16, 185, 129, 0.3); }
        .glow-sm { box-shadow: 0 0 20px rgba(16, 185, 129, 0.2); }
        
        .loader { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .match-card { transition: all 0.3s ease; }
        .match-card:hover { transform: translateY(-2px); box-shadow: 0 15px 30px rgba(0,0,0,0.3); }
        
        .pick-btn { transition: all 0.2s ease; cursor: pointer; }
        .pick-btn:hover { transform: scale(1.02); }
        .pick-btn.recommended { border: 2px solid #10b981; background: rgba(16, 185, 129, 0.15); }
        
        .conf-high { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .conf-mid { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .conf-low { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        
        .result-won { background: rgba(16, 185, 129, 0.15); border-color: rgba(16, 185, 129, 0.5); }
        .result-lost { background: rgba(239, 68, 68, 0.15); border-color: rgba(239, 68, 68, 0.5); }
        
        .nav-item { transition: all 0.2s ease; position: relative; }
        .nav-item.active { color: #10b981; }
        .nav-item.active::after { content: ''; position: absolute; bottom: -4px; left: 50%; transform: translateX(-50%); width: 4px; height: 4px; background: #10b981; border-radius: 50%; }
        
        input, select { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 12px; padding: 12px 16px; }
        input:focus, select:focus { outline: none; border-color: #10b981; box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2); }
        
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #10b981; border-radius: 2px; }
        
        .quality-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; }
        .quality-A { background: #10b981; color: white; }
        .quality-B { background: #3b82f6; color: white; }
        .quality-C { background: #f59e0b; color: white; }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // ============================================================
        // üéØ BOMBA BET PRO V2 - ALGORITMO AVANZATO
        // ============================================================
        // ‚úÖ Firebase Realtime Database
        // ‚úÖ Database statistiche reali per squadra
        // ‚úÖ Algoritmo avanzato multi-fattore
        // ‚úÖ Palinsesto completo multi-campionato
        // ‚úÖ Qualit√† pronostico (A/B/C)
        // ============================================================

        // Firebase Config - TUO DATABASE
        const firebaseConfig = {
            apiKey: "AIzaSyBxYjMK0ypcLT_5XaQjMtMEDwf7rTjLOEI",
            authDomain: "bombabet26.firebaseapp.com",
            databaseURL: "https://bombabet26-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "bombabet26",
            storageBucket: "bombabet26.firebasestorage.app",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abc123"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        const PROXY = (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`;
        const FD_API = 'https://api.football-data.org/v4';

        // ============================================================
        // üìä DATABASE STATISTICHE REALI (da FootyStats, SofaScore, etc.)
        // ============================================================
        // Formato: cornersPG (per gara), cornersConcededPG, cardsPG, ggRate%, over25%
        
        const TEAM_STATS = {
            // üáÆüáπ SERIE A
            "Napoli": { corners: 5.8, cornersAg: 3.9, cards: 1.8, cardsAg: 2.1, ggRate: 58, over25: 62 },
            "Inter": { corners: 6.2, cornersAg: 3.5, cards: 1.6, cardsAg: 1.9, ggRate: 55, over25: 58 },
            "Milan": { corners: 5.5, cornersAg: 4.2, cards: 2.0, cardsAg: 1.8, ggRate: 60, over25: 55 },
            "Juventus": { corners: 5.8, cornersAg: 3.8, cards: 1.9, cardsAg: 1.7, ggRate: 48, over25: 45 },
            "Atalanta": { corners: 6.5, cornersAg: 4.0, cards: 2.2, cardsAg: 2.0, ggRate: 68, over25: 72 },
            "Roma": { corners: 5.2, cornersAg: 4.5, cards: 2.3, cardsAg: 2.1, ggRate: 52, over25: 50 },
            "Lazio": { corners: 5.4, cornersAg: 4.3, cards: 2.1, cardsAg: 2.2, ggRate: 55, over25: 58 },
            "Fiorentina": { corners: 5.0, cornersAg: 4.8, cards: 2.0, cardsAg: 2.3, ggRate: 50, over25: 48 },
            "Bologna": { corners: 5.3, cornersAg: 4.2, cards: 2.4, cardsAg: 2.0, ggRate: 55, over25: 52 },
            "Torino": { corners: 4.8, cornersAg: 5.0, cards: 2.5, cardsAg: 2.2, ggRate: 48, over25: 45 },
            "Udinese": { corners: 4.5, cornersAg: 5.2, cards: 2.2, cardsAg: 2.4, ggRate: 45, over25: 42 },
            "Genoa": { corners: 4.2, cornersAg: 5.5, cards: 2.3, cardsAg: 2.5, ggRate: 50, over25: 48 },
            "Cagliari": { corners: 4.3, cornersAg: 5.3, cards: 2.6, cardsAg: 2.3, ggRate: 52, over25: 50 },
            "Parma": { corners: 4.0, cornersAg: 5.8, cards: 2.4, cardsAg: 2.6, ggRate: 55, over25: 52 },
            "Empoli": { corners: 4.2, cornersAg: 5.5, cards: 2.2, cardsAg: 2.4, ggRate: 42, over25: 38 },
            "Como": { corners: 4.5, cornersAg: 5.2, cards: 2.3, cardsAg: 2.5, ggRate: 55, over25: 52 },
            "Verona": { corners: 4.0, cornersAg: 5.8, cards: 2.5, cardsAg: 2.7, ggRate: 58, over25: 55 },
            "Lecce": { corners: 3.8, cornersAg: 6.0, cards: 2.4, cardsAg: 2.8, ggRate: 45, over25: 40 },
            "Venezia": { corners: 3.5, cornersAg: 6.2, cards: 2.6, cardsAg: 2.5, ggRate: 48, over25: 45 },
            "Monza": { corners: 4.0, cornersAg: 5.5, cards: 2.3, cardsAg: 2.4, ggRate: 42, over25: 38 },
            
            // üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø PREMIER LEAGUE
            "Liverpool": { corners: 7.2, cornersAg: 3.2, cards: 1.4, cardsAg: 1.6, ggRate: 55, over25: 65 },
            "Arsenal": { corners: 6.8, cornersAg: 3.5, cards: 1.6, cardsAg: 1.5, ggRate: 52, over25: 58 },
            "Manchester City": { corners: 7.5, cornersAg: 2.8, cards: 1.3, cardsAg: 1.4, ggRate: 48, over25: 62 },
            "Chelsea": { corners: 6.2, cornersAg: 4.0, cards: 1.8, cardsAg: 1.7, ggRate: 58, over25: 60 },
            "Manchester United": { corners: 5.5, cornersAg: 4.5, cards: 1.9, cardsAg: 2.0, ggRate: 55, over25: 52 },
            "Tottenham": { corners: 5.8, cornersAg: 4.2, cards: 1.7, cardsAg: 1.8, ggRate: 60, over25: 65 },
            "Newcastle": { corners: 5.5, cornersAg: 4.0, cards: 1.8, cardsAg: 1.9, ggRate: 52, over25: 55 },
            "Aston Villa": { corners: 5.2, cornersAg: 4.5, cards: 2.0, cardsAg: 1.8, ggRate: 55, over25: 58 },
            "Brighton": { corners: 5.5, cornersAg: 4.3, cards: 1.6, cardsAg: 1.7, ggRate: 50, over25: 52 },
            "West Ham": { corners: 4.8, cornersAg: 5.0, cards: 2.1, cardsAg: 2.0, ggRate: 52, over25: 50 },
            "Bournemouth": { corners: 4.5, cornersAg: 5.2, cards: 1.9, cardsAg: 2.2, ggRate: 55, over25: 55 },
            "Fulham": { corners: 4.8, cornersAg: 5.0, cards: 2.0, cardsAg: 2.1, ggRate: 52, over25: 50 },
            "Crystal Palace": { corners: 4.5, cornersAg: 5.5, cards: 2.2, cardsAg: 2.0, ggRate: 48, over25: 45 },
            "Brentford": { corners: 4.8, cornersAg: 5.0, cards: 2.0, cardsAg: 2.2, ggRate: 58, over25: 58 },
            "Nottingham Forest": { corners: 4.2, cornersAg: 5.5, cards: 2.3, cardsAg: 2.1, ggRate: 45, over25: 42 },
            "Everton": { corners: 4.0, cornersAg: 5.8, cards: 2.4, cardsAg: 2.3, ggRate: 45, over25: 42 },
            "Wolves": { corners: 4.5, cornersAg: 5.2, cards: 2.2, cardsAg: 2.4, ggRate: 42, over25: 40 },
            "Leicester": { corners: 4.8, cornersAg: 5.0, cards: 2.0, cardsAg: 2.2, ggRate: 55, over25: 55 },
            "Ipswich": { corners: 3.8, cornersAg: 6.0, cards: 2.3, cardsAg: 2.5, ggRate: 50, over25: 48 },
            "Southampton": { corners: 3.5, cornersAg: 6.5, cards: 2.5, cardsAg: 2.6, ggRate: 55, over25: 52 },
            
            // üá™üá∏ LA LIGA
            "Real Madrid": { corners: 6.5, cornersAg: 3.5, cards: 1.8, cardsAg: 2.0, ggRate: 52, over25: 58 },
            "Barcelona": { corners: 7.0, cornersAg: 3.2, cards: 1.6, cardsAg: 1.8, ggRate: 58, over25: 65 },
            "Atletico Madrid": { corners: 5.5, cornersAg: 3.8, cards: 2.5, cardsAg: 2.2, ggRate: 45, over25: 42 },
            "Athletic Bilbao": { corners: 5.8, cornersAg: 4.0, cards: 2.3, cardsAg: 2.0, ggRate: 50, over25: 48 },
            "Villarreal": { corners: 5.5, cornersAg: 4.2, cards: 2.0, cardsAg: 2.2, ggRate: 55, over25: 55 },
            "Real Sociedad": { corners: 5.2, cornersAg: 4.5, cards: 2.2, cardsAg: 2.3, ggRate: 48, over25: 45 },
            "Real Betis": { corners: 5.0, cornersAg: 4.8, cards: 2.4, cardsAg: 2.5, ggRate: 52, over25: 50 },
            "Sevilla": { corners: 5.2, cornersAg: 4.5, cards: 2.3, cardsAg: 2.4, ggRate: 50, over25: 48 },
            "Girona": { corners: 5.5, cornersAg: 4.2, cards: 2.0, cardsAg: 2.2, ggRate: 58, over25: 60 },
            "Mallorca": { corners: 4.5, cornersAg: 5.0, cards: 2.5, cardsAg: 2.6, ggRate: 42, over25: 38 },
            "Osasuna": { corners: 4.8, cornersAg: 5.2, cards: 2.6, cardsAg: 2.8, ggRate: 48, over25: 45 },
            "Celta Vigo": { corners: 4.5, cornersAg: 5.5, cards: 2.4, cardsAg: 2.5, ggRate: 55, over25: 52 },
            "Rayo Vallecano": { corners: 4.2, cornersAg: 5.5, cards: 2.8, cardsAg: 2.6, ggRate: 48, over25: 45 },
            "Valencia": { corners: 4.5, cornersAg: 5.2, cards: 2.5, cardsAg: 2.7, ggRate: 50, over25: 48 },
            "Getafe": { corners: 3.8, cornersAg: 5.8, cards: 3.0, cardsAg: 2.8, ggRate: 40, over25: 35 },
            "Espanyol": { corners: 4.0, cornersAg: 5.5, cards: 2.6, cardsAg: 2.5, ggRate: 45, over25: 42 },
            "Alaves": { corners: 4.2, cornersAg: 5.5, cards: 2.5, cardsAg: 2.7, ggRate: 48, over25: 45 },
            "Las Palmas": { corners: 4.5, cornersAg: 5.2, cards: 2.3, cardsAg: 2.5, ggRate: 50, over25: 48 },
            "Leganes": { corners: 3.8, cornersAg: 5.8, cards: 2.4, cardsAg: 2.6, ggRate: 42, over25: 38 },
            "Valladolid": { corners: 3.5, cornersAg: 6.0, cards: 2.6, cardsAg: 2.8, ggRate: 45, over25: 42 },
            
            // üá©üá™ BUNDESLIGA
            "Bayern Munich": { corners: 7.5, cornersAg: 3.0, cards: 1.5, cardsAg: 1.4, ggRate: 55, over25: 68 },
            "Bayer Leverkusen": { corners: 6.8, cornersAg: 3.5, cards: 1.6, cardsAg: 1.5, ggRate: 52, over25: 62 },
            "RB Leipzig": { corners: 6.2, cornersAg: 3.8, cards: 1.8, cardsAg: 1.7, ggRate: 55, over25: 60 },
            "Borussia Dortmund": { corners: 6.5, cornersAg: 4.0, cards: 1.7, cardsAg: 1.8, ggRate: 62, over25: 68 },
            "Eintracht Frankfurt": { corners: 5.5, cornersAg: 4.5, cards: 2.0, cardsAg: 2.2, ggRate: 58, over25: 62 },
            "VfB Stuttgart": { corners: 5.8, cornersAg: 4.2, cards: 1.9, cardsAg: 2.0, ggRate: 60, over25: 65 },
            "Freiburg": { corners: 5.0, cornersAg: 4.8, cards: 2.2, cardsAg: 2.0, ggRate: 52, over25: 50 },
            "Wolfsburg": { corners: 5.2, cornersAg: 4.5, cards: 2.0, cardsAg: 2.1, ggRate: 50, over25: 48 },
            "Union Berlin": { corners: 4.5, cornersAg: 5.0, cards: 2.3, cardsAg: 2.2, ggRate: 45, over25: 42 },
            "Werder Bremen": { corners: 4.8, cornersAg: 5.2, cards: 2.1, cardsAg: 2.3, ggRate: 55, over25: 55 },
            "Borussia Monchengladbach": { corners: 4.8, cornersAg: 5.0, cards: 2.0, cardsAg: 2.2, ggRate: 52, over25: 52 },
            "Mainz": { corners: 4.5, cornersAg: 5.5, cards: 2.4, cardsAg: 2.5, ggRate: 55, over25: 52 },
            "Augsburg": { corners: 4.2, cornersAg: 5.5, cards: 2.5, cardsAg: 2.6, ggRate: 50, over25: 48 },
            "Hoffenheim": { corners: 5.0, cornersAg: 5.0, cards: 2.2, cardsAg: 2.3, ggRate: 55, over25: 55 },
            "Heidenheim": { corners: 4.5, cornersAg: 5.2, cards: 2.3, cardsAg: 2.4, ggRate: 52, over25: 50 },
            "St Pauli": { corners: 4.0, cornersAg: 5.8, cards: 2.4, cardsAg: 2.5, ggRate: 48, over25: 45 },
            "Holstein Kiel": { corners: 3.8, cornersAg: 6.0, cards: 2.5, cardsAg: 2.7, ggRate: 55, over25: 52 },
            "Bochum": { corners: 3.5, cornersAg: 6.2, cards: 2.6, cardsAg: 2.8, ggRate: 50, over25: 48 },
            
            // üá´üá∑ LIGUE 1
            "Paris Saint-Germain": { corners: 7.8, cornersAg: 2.8, cards: 1.5, cardsAg: 1.8, ggRate: 48, over25: 58 },
            "Monaco": { corners: 5.8, cornersAg: 4.0, cards: 1.8, cardsAg: 2.0, ggRate: 55, over25: 58 },
            "Marseille": { corners: 6.0, cornersAg: 4.2, cards: 2.2, cardsAg: 2.0, ggRate: 52, over25: 55 },
            "Lille": { corners: 5.5, cornersAg: 4.0, cards: 2.0, cardsAg: 2.2, ggRate: 48, over25: 50 },
            "Lyon": { corners: 5.5, cornersAg: 4.5, cards: 2.0, cardsAg: 2.3, ggRate: 55, over25: 55 },
            "Nice": { corners: 5.2, cornersAg: 4.5, cards: 2.3, cardsAg: 2.2, ggRate: 45, over25: 42 },
            "Lens": { corners: 5.0, cornersAg: 4.8, cards: 2.2, cardsAg: 2.4, ggRate: 48, over25: 45 },
            "Rennes": { corners: 5.2, cornersAg: 4.8, cards: 2.0, cardsAg: 2.2, ggRate: 52, over25: 52 },
            "Strasbourg": { corners: 4.8, cornersAg: 5.0, cards: 2.3, cardsAg: 2.5, ggRate: 55, over25: 55 },
            "Toulouse": { corners: 4.5, cornersAg: 5.2, cards: 2.2, cardsAg: 2.4, ggRate: 52, over25: 50 },
            "Reims": { corners: 4.5, cornersAg: 5.0, cards: 2.4, cardsAg: 2.5, ggRate: 45, over25: 42 },
            "Auxerre": { corners: 4.2, cornersAg: 5.5, cards: 2.5, cardsAg: 2.6, ggRate: 50, over25: 48 },
            "Nantes": { corners: 4.5, cornersAg: 5.2, cards: 2.3, cardsAg: 2.5, ggRate: 48, over25: 45 },
            "Angers": { corners: 4.0, cornersAg: 5.8, cards: 2.6, cardsAg: 2.7, ggRate: 45, over25: 42 },
            "Saint-Etienne": { corners: 4.2, cornersAg: 5.5, cards: 2.5, cardsAg: 2.8, ggRate: 48, over25: 45 },
            "Le Havre": { corners: 3.8, cornersAg: 6.0, cards: 2.4, cardsAg: 2.6, ggRate: 42, over25: 38 },
            "Montpellier": { corners: 4.0, cornersAg: 5.8, cards: 2.6, cardsAg: 2.8, ggRate: 50, over25: 48 },
            "Brest": { corners: 5.0, cornersAg: 4.8, cards: 2.2, cardsAg: 2.4, ggRate: 48, over25: 45 },
            
            // üèÜ CHAMPIONS LEAGUE EXTRA
            "PSV": { corners: 6.0, cornersAg: 4.0, cards: 1.8, cardsAg: 2.0, ggRate: 55, over25: 58 },
            "Feyenoord": { corners: 5.5, cornersAg: 4.5, cards: 2.0, cardsAg: 2.2, ggRate: 58, over25: 60 },
            "Ajax": { corners: 6.2, cornersAg: 4.0, cards: 1.9, cardsAg: 2.0, ggRate: 55, over25: 58 },
            "Sporting CP": { corners: 5.8, cornersAg: 4.2, cards: 2.0, cardsAg: 2.2, ggRate: 52, over25: 55 },
            "Benfica": { corners: 6.0, cornersAg: 4.0, cards: 1.8, cardsAg: 2.0, ggRate: 55, over25: 58 },
            "Porto": { corners: 5.5, cornersAg: 4.5, cards: 2.2, cardsAg: 2.4, ggRate: 50, over25: 52 },
            "Celtic": { corners: 6.5, cornersAg: 3.5, cards: 1.8, cardsAg: 2.0, ggRate: 58, over25: 62 },
            "Club Brugge": { corners: 5.5, cornersAg: 4.5, cards: 2.0, cardsAg: 2.2, ggRate: 52, over25: 55 },
            "Red Bull Salzburg": { corners: 5.8, cornersAg: 4.2, cards: 1.9, cardsAg: 2.1, ggRate: 55, over25: 58 },
            "Shakhtar Donetsk": { corners: 5.5, cornersAg: 4.5, cards: 2.0, cardsAg: 2.2, ggRate: 52, over25: 55 },
            "Dinamo Zagreb": { corners: 5.2, cornersAg: 4.8, cards: 2.2, cardsAg: 2.4, ggRate: 50, over25: 52 },
            "Sparta Praha": { corners: 5.0, cornersAg: 5.0, cards: 2.3, cardsAg: 2.5, ggRate: 48, over25: 50 },
            "Slovan Bratislava": { corners: 4.5, cornersAg: 5.5, cards: 2.4, cardsAg: 2.6, ggRate: 45, over25: 45 },
            "Young Boys": { corners: 4.8, cornersAg: 5.2, cards: 2.2, cardsAg: 2.4, ggRate: 50, over25: 52 },
            "Sturm Graz": { corners: 4.5, cornersAg: 5.5, cards: 2.5, cardsAg: 2.7, ggRate: 48, over25: 48 }
        };

        // Campionati
        const LEAGUES = {
            SA: { name: "Serie A", flag: "üáÆüáπ", avgCorners: 10.3, avgCards: 4.2 },
            PL: { name: "Premier League", flag: "üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø", avgCorners: 10.8, avgCards: 3.6 },
            PD: { name: "La Liga", flag: "üá™üá∏", avgCorners: 9.9, avgCards: 4.8 },
            BL1: { name: "Bundesliga", flag: "üá©üá™", avgCorners: 10.6, avgCards: 3.5 },
            FL1: { name: "Ligue 1", flag: "üá´üá∑", avgCorners: 10.1, avgCards: 4.0 },
            CL: { name: "Champions League", flag: "üèÜ", avgCorners: 10.8, avgCards: 3.2 },
            ELC: { name: "Championship", flag: "üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø", avgCorners: 10.5, avgCards: 3.8 },
            DED: { name: "Eredivisie", flag: "üá≥üá±", avgCorners: 10.2, avgCards: 4.0 },
            PPL: { name: "Primeira Liga", flag: "üáµüáπ", avgCorners: 9.8, avgCards: 4.5 }
        };

        // State
        let state = {
            user: null,
            apiKey: localStorage.getItem('bombaBetApiKey') || '',
            view: 'loading',
            selectedLeague: 'ALL',
            allMatches: [],
            filteredMatches: [],
            selectedMatch: null,
            analysisData: null,
            predictions: [],
            loading: false,
            error: null,
            stats: { total: 0, won: 0, lost: 0, pending: 0 },
            dateFilter: 'today'
        };

        // ============================================================
        // FIREBASE AUTH & REALTIME DATABASE
        // ============================================================

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                state.user = user;
                state.apiKey = localStorage.getItem('bombaBetApiKey') || '';
                if (!state.apiKey) {
                    state.view = 'setup';
                } else {
                    state.view = 'main';
                    await loadUserStats();
                }
            } else {
                state.user = null;
                state.view = 'auth';
            }
            render();
        });

        async function signInWithEmail(email, password) {
            try {
                state.loading = true;
                state.error = null;
                render();
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                state.error = getErrorMessage(error.code);
                state.loading = false;
                render();
            }
        }

        async function signUpWithEmail(email, password, name) {
            try {
                state.loading = true;
                state.error = null;
                render();
                const result = await auth.createUserWithEmailAndPassword(email, password);
                await result.user.updateProfile({ displayName: name });
                await database.ref(`users/${result.user.uid}/profile`).set({
                    name,
                    email,
                    createdAt: Date.now()
                });
            } catch (error) {
                state.error = getErrorMessage(error.code);
                state.loading = false;
                render();
            }
        }

        async function signInWithGoogle() {
            try {
                state.loading = true;
                render();
                const provider = new firebase.auth.GoogleAuthProvider();
                await auth.signInWithPopup(provider);
            } catch (error) {
                state.error = getErrorMessage(error.code);
                state.loading = false;
                render();
            }
        }

        function signOut() { auth.signOut(); }

        function getErrorMessage(code) {
            const msgs = {
                'auth/email-already-in-use': 'Email gi√† registrata',
                'auth/invalid-email': 'Email non valida',
                'auth/wrong-password': 'Password errata',
                'auth/user-not-found': 'Utente non trovato',
                'auth/weak-password': 'Password min 6 caratteri',
                'auth/invalid-credential': 'Credenziali non valide'
            };
            return msgs[code] || 'Errore autenticazione';
        }

        async function loadUserStats() {
            if (!state.user) return;
            try {
                const snapshot = await database.ref(`users/${state.user.uid}/predictions`).once('value');
                const data = snapshot.val() || {};
                let total = 0, won = 0, lost = 0, pending = 0;
                Object.values(data).forEach(p => {
                    total++;
                    if (p.result === 'won') won++;
                    else if (p.result === 'lost') lost++;
                    else pending++;
                });
                state.stats = { total, won, lost, pending };
            } catch (e) { console.error(e); }
        }

        async function savePrediction(matchInfo, pickType, pickValue, conf, quality) {
            if (!state.user) return;
            try {
                const newRef = database.ref(`users/${state.user.uid}/predictions`).push();
                await newRef.set({
                    matchInfo,
                    pickType,
                    pickValue,
                    confidence: Math.round(conf),
                    quality,
                    result: null,
                    createdAt: Date.now()
                });
                state.stats.total++;
                state.stats.pending++;
                showToast('‚úÖ Salvato!');
                render();
            } catch (e) {
                showToast('‚ùå Errore');
            }
        }

        async function loadPredictions() {
            if (!state.user) return [];
            try {
                const snapshot = await database.ref(`users/${state.user.uid}/predictions`).orderByChild('createdAt').limitToLast(50).once('value');
                const data = snapshot.val() || {};
                return Object.entries(data).map(([id, p]) => ({ id, ...p })).reverse();
            } catch (e) { return []; }
        }

        async function updatePredictionResult(id, result) {
            if (!state.user) return;
            try {
                await database.ref(`users/${state.user.uid}/predictions/${id}`).update({ result });
                if (result === 'won') { state.stats.won++; state.stats.pending--; }
                else if (result === 'lost') { state.stats.lost++; state.stats.pending--; }
                render();
            } catch (e) { showToast('‚ùå Errore'); }
        }

        // ============================================================
        // üß† ALGORITMO AVANZATO
        // ============================================================

        function getTeamStats(teamName) {
            // Cerca match esatto o parziale
            let stats = TEAM_STATS[teamName];
            if (stats) return { ...stats, found: true };
            
            // Cerca per nome parziale
            const key = Object.keys(TEAM_STATS).find(k => 
                teamName.toLowerCase().includes(k.toLowerCase()) || 
                k.toLowerCase().includes(teamName.toLowerCase())
            );
            if (key) return { ...TEAM_STATS[key], found: true };
            
            // Default stats se non trovato
            return { corners: 5.0, cornersAg: 5.0, cards: 2.2, cardsAg: 2.2, ggRate: 50, over25: 50, found: false };
        }

        function analyzeAdvanced(homeTeam, awayTeam, leagueCode) {
            const ld = LEAGUES[leagueCode] || LEAGUES.SA;
            const home = getTeamStats(homeTeam);
            const away = getTeamStats(awayTeam);
            
            const dataQuality = home.found && away.found ? 'A' : (home.found || away.found ? 'B' : 'C');
            
            // ============================================================
            // üö© CORNER ALGORITHM
            // ============================================================
            // Formula: (Corner fatti squadra + Corner subiti avversario) / 2 + fattore casa
            const homeCornerExp = (home.corners * 1.08 + away.cornersAg * 0.92) / 2; // Boost casa
            const awayCornerExp = (away.corners * 0.92 + home.cornersAg * 1.08) / 2; // Penalit√† trasferta
            const totalCornersExp = homeCornerExp + awayCornerExp;
            
            const cornerPreds = {};
            [8.5, 9.5, 10.5, 11.5].forEach(line => {
                const diff = totalCornersExp - line;
                // Sigma pi√π stretto per dati reali
                const sigma = dataQuality === 'A' ? 1.8 : (dataQuality === 'B' ? 2.2 : 2.5);
                const zScore = diff / sigma;
                const prob = 50 + zScore * 20;
                const clampedProb = Math.max(25, Math.min(78, prob));
                const conf = dataQuality === 'A' ? 
                    Math.min(85, 50 + Math.abs(diff) * 9) :
                    Math.min(75, 45 + Math.abs(diff) * 7);
                
                cornerPreds[line] = {
                    pick: clampedProb > 50 ? 'OVER' : 'UNDER',
                    prob: clampedProb,
                    conf: Math.max(40, conf),
                    quality: dataQuality
                };
            });

            const homeCornerPreds = {}, awayCornerPreds = {};
            [3.5, 4.5, 5.5].forEach(line => {
                const hDiff = homeCornerExp - line;
                const aDiff = awayCornerExp - line;
                const hProb = Math.max(28, Math.min(72, 50 + hDiff * 12));
                const aProb = Math.max(28, Math.min(72, 50 + aDiff * 12));
                const hConf = dataQuality === 'A' ? Math.min(80, 48 + Math.abs(hDiff) * 10) : Math.min(70, 42 + Math.abs(hDiff) * 8);
                const aConf = dataQuality === 'A' ? Math.min(80, 48 + Math.abs(aDiff) * 10) : Math.min(70, 42 + Math.abs(aDiff) * 8);
                
                homeCornerPreds[line] = { pick: hProb > 50 ? 'OVER' : 'UNDER', prob: hProb, conf: hConf, quality: dataQuality };
                awayCornerPreds[line] = { pick: aProb > 50 ? 'OVER' : 'UNDER', prob: aProb, conf: aConf, quality: dataQuality };
            });

            // ============================================================
            // üü® CARDS ALGORITHM
            // ============================================================
            const homeCardsExp = (home.cards * 0.9 + away.cardsAg * 1.1) / 2;
            const awayCardsExp = (away.cards * 1.1 + home.cardsAg * 0.9) / 2;
            const totalCardsExp = homeCardsExp + awayCardsExp;

            const cardPreds = {};
            [3.5, 4.5, 5.5].forEach(line => {
                const diff = totalCardsExp - line;
                const prob = Math.max(25, Math.min(75, 50 + diff * 14));
                const conf = dataQuality === 'A' ? 
                    Math.min(82, 48 + Math.abs(diff) * 11) :
                    Math.min(72, 42 + Math.abs(diff) * 9);
                
                cardPreds[line] = {
                    pick: prob > 50 ? 'OVER' : 'UNDER',
                    prob,
                    conf: Math.max(38, conf),
                    quality: dataQuality
                };
            });

            const homeCardPreds = {}, awayCardPreds = {};
            [1.5, 2.5].forEach(line => {
                const hDiff = homeCardsExp - line;
                const aDiff = awayCardsExp - line;
                const hProb = Math.max(30, Math.min(70, 50 + hDiff * 18));
                const aProb = Math.max(30, Math.min(70, 50 + aDiff * 18));
                const hConf = dataQuality === 'A' ? Math.min(78, 45 + Math.abs(hDiff) * 12) : Math.min(68, 40 + Math.abs(hDiff) * 10);
                const aConf = dataQuality === 'A' ? Math.min(78, 45 + Math.abs(aDiff) * 12) : Math.min(68, 40 + Math.abs(aDiff) * 10);
                
                homeCardPreds[line] = { pick: hProb > 50 ? 'OVER' : 'UNDER', prob: hProb, conf: hConf, quality: dataQuality };
                awayCardPreds[line] = { pick: aProb > 50 ? 'OVER' : 'UNDER', prob: aProb, conf: aConf, quality: dataQuality };
            });

            // ============================================================
            // ‚öΩ GG/NG ALGORITHM
            // ============================================================
            // Media pesata dei GG rate delle due squadre
            const ggProb = (home.ggRate + away.ggRate) / 2;
            const ggAdjusted = Math.max(32, Math.min(72, ggProb));
            const ggConf = dataQuality === 'A' ? 
                Math.min(82, 48 + Math.abs(ggAdjusted - 50) * 0.9) :
                Math.min(72, 42 + Math.abs(ggAdjusted - 50) * 0.7);

            return {
                dataQuality,
                homeStats: home,
                awayStats: away,
                gg: { 
                    prob: ggAdjusted, 
                    conf: ggConf, 
                    quality: dataQuality 
                },
                corners: {
                    total: totalCornersExp,
                    home: homeCornerExp,
                    away: awayCornerExp,
                    preds: cornerPreds,
                    homePreds: homeCornerPreds,
                    awayPreds: awayCornerPreds
                },
                cards: {
                    total: totalCardsExp,
                    home: homeCardsExp,
                    away: awayCardsExp,
                    preds: cardPreds,
                    homePreds: homeCardPreds,
                    awayPreds: awayCardPreds
                }
            };
        }

        // ============================================================
        // API - PALINSESTO COMPLETO
        // ============================================================

        async function apiCall(endpoint) {
            const url = PROXY(`${FD_API}${endpoint}`);
            const response = await fetch(url, {
                headers: { 'X-Auth-Token': state.apiKey }
            });
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return await response.json();
        }

        async function loadAllMatches() {
            state.loading = true;
            state.error = null;
            state.allMatches = [];
            render();

            const leagues = ['SA', 'PL', 'PD', 'BL1', 'FL1', 'CL', 'ELC', 'DED', 'PPL'];
            const allMatches = [];

            try {
                // Carica da tutti i campionati in parallelo
                const promises = leagues.map(async (code) => {
                    try {
                        const data = await apiCall(`/competitions/${code}/matches?status=SCHEDULED,TIMED`);
                        return (data.matches || []).map(m => ({ ...m, leagueCode: code }));
                    } catch (e) {
                        console.log(`Skip ${code}:`, e.message);
                        return [];
                    }
                });

                const results = await Promise.all(promises);
                results.forEach(matches => allMatches.push(...matches));

                // Ordina per data
                allMatches.sort((a, b) => new Date(a.utcDate) - new Date(b.utcDate));
                
                state.allMatches = allMatches;
                filterMatches();
                state.view = 'matches';
            } catch (e) {
                state.error = 'Errore nel caricamento';
            }

            state.loading = false;
            render();
        }

        function filterMatches() {
            let matches = [...state.allMatches];
            
            // Filtro campionato
            if (state.selectedLeague !== 'ALL') {
                matches = matches.filter(m => m.leagueCode === state.selectedLeague);
            }
            
            // Filtro data
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const tomorrow = new Date(today.getTime() + 24 * 60 * 60 * 1000);
            const week = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
            
            if (state.dateFilter === 'today') {
                matches = matches.filter(m => {
                    const d = new Date(m.utcDate);
                    return d >= today && d < tomorrow;
                });
            } else if (state.dateFilter === 'tomorrow') {
                matches = matches.filter(m => {
                    const d = new Date(m.utcDate);
                    return d >= tomorrow && d < new Date(tomorrow.getTime() + 24 * 60 * 60 * 1000);
                });
            } else if (state.dateFilter === 'week') {
                matches = matches.filter(m => {
                    const d = new Date(m.utcDate);
                    return d >= today && d < week;
                });
            }
            
            state.filteredMatches = matches;
        }

        // ============================================================
        // UTILITIES
        // ============================================================

        function showToast(msg) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-24 left-1/2 transform -translate-x-1/2 gradient-primary text-white px-6 py-3 rounded-full font-bold z-50 fade-in shadow-lg';
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        function formatDate(dateStr) {
            const d = new Date(dateStr);
            return {
                date: d.toLocaleDateString('it-IT', { weekday: 'short', day: '2-digit', month: '2-digit' }),
                time: d.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' })
            };
        }

        function confClass(v) {
            return v >= 65 ? 'conf-high' : v >= 52 ? 'conf-mid' : 'conf-low';
        }

        function esc(s) {
            return String(s || '').replace(/'/g, "\\'").replace(/"/g, '\\"');
        }

        // ============================================================
        // RENDER
        // ============================================================

        function render() {
            const app = document.getElementById('app');

            if (state.view === 'loading') {
                app.innerHTML = `<div class="min-h-screen flex items-center justify-center"><div class="w-16 h-16 border-4 border-emerald-500 border-t-transparent rounded-full loader"></div></div>`;
                return;
            }

            if (state.view === 'auth') { app.innerHTML = renderAuth(); return; }
            if (state.view === 'setup') { app.innerHTML = renderSetup(); return; }

            app.innerHTML = renderMain();
        }

        function renderAuth() {
            return `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="glass rounded-3xl p-8 max-w-md w-full fade-in">
                        <div class="text-center mb-8">
                            <div class="w-24 h-24 gradient-primary rounded-3xl flex items-center justify-center mx-auto mb-4 glow">
                                <span class="text-5xl">‚öΩ</span>
                            </div>
                            <h1 class="text-3xl font-black gradient-text">BOMBA BET</h1>
                            <p class="text-gray-400 mt-2">PRO V2 - Algoritmo Avanzato</p>
                        </div>

                        <div class="space-y-4 mb-6">
                            <input type="email" id="emailInput" placeholder="Email" class="w-full" />
                            <input type="password" id="passwordInput" placeholder="Password" class="w-full" />
                            <input type="text" id="nameInput" placeholder="Nome (solo registrazione)" class="w-full hidden" />
                        </div>

                        ${state.error ? `<p class="text-red-400 text-sm text-center mb-4">${state.error}</p>` : ''}

                        <button onclick="handleEmailAuth()" class="w-full gradient-primary py-4 rounded-xl font-bold text-white mb-3" ${state.loading ? 'disabled' : ''}>
                            ${state.loading ? '‚è≥' : 'üöÄ'} Accedi
                        </button>

                        <button onclick="toggleAuthMode()" class="w-full text-emerald-400 text-sm font-medium mb-6">
                            Non hai un account? Registrati
                        </button>

                        <div class="relative mb-6">
                            <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-700"></div></div>
                            <div class="relative flex justify-center"><span class="bg-slate-800 px-4 text-gray-500 text-sm">oppure</span></div>
                        </div>

                        <button onclick="signInWithGoogle()" class="w-full glass-light py-4 rounded-xl font-bold flex items-center justify-center gap-3">
                            <svg class="w-5 h-5" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                            Google
                        </button>
                    </div>
                </div>
            `;
        }

        function renderSetup() {
            return `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="glass rounded-3xl p-8 max-w-md w-full fade-in">
                        <div class="text-center mb-8">
                            <div class="w-20 h-20 gradient-primary rounded-2xl flex items-center justify-center mx-auto mb-4">üîë</div>
                            <h2 class="text-2xl font-bold">API Key</h2>
                            <p class="text-gray-400 text-sm mt-2">football-data.org</p>
                        </div>
                        <input type="text" id="apiKeyInput" placeholder="Incolla API Key" class="w-full mb-4" />
                        <button onclick="saveApiKey()" class="w-full gradient-primary py-4 rounded-xl font-bold text-white">‚úÖ Salva</button>
                        <p class="text-xs text-gray-500 text-center mt-4">Gratis su <a href="https://www.football-data.org/client/register" target="_blank" class="text-emerald-400">football-data.org</a></p>
                    </div>
                </div>
            `;
        }

        function renderMain() {
            const hitRate = state.stats.won + state.stats.lost > 0 ? ((state.stats.won / (state.stats.won + state.stats.lost)) * 100).toFixed(1) : '0';
            let content = '';

            // MAIN VIEW
            if (state.view === 'main') {
                content = `
                    <div class="glass rounded-2xl p-5 mb-6 glow-sm">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 gradient-primary rounded-xl flex items-center justify-center">üìä</div>
                                <div>
                                    <p class="font-bold">Le Tue Stats</p>
                                    <p class="text-xs text-gray-400">${state.stats.total} pronostici</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-2xl font-black gradient-text">${hitRate}%</p>
                                <p class="text-xs text-gray-400">Hit Rate</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-3">
                            <div class="glass-light rounded-xl p-3 text-center">
                                <p class="text-xl font-bold text-emerald-400">${state.stats.won}</p>
                                <p class="text-xs text-gray-400">Win</p>
                            </div>
                            <div class="glass-light rounded-xl p-3 text-center">
                                <p class="text-xl font-bold text-red-400">${state.stats.lost}</p>
                                <p class="text-xs text-gray-400">Lost</p>
                            </div>
                            <div class="glass-light rounded-xl p-3 text-center">
                                <p class="text-xl font-bold text-yellow-400">${state.stats.pending}</p>
                                <p class="text-xs text-gray-400">Pending</p>
                            </div>
                        </div>
                    </div>

                    <div class="glass rounded-2xl p-5 mb-6">
                        <p class="font-bold mb-3">üß† Algoritmo V2</p>
                        <div class="grid grid-cols-3 gap-2 text-center text-xs">
                            <div class="glass-light rounded-lg p-2"><span class="quality-badge quality-A">A</span><p class="mt-1">Dati completi</p></div>
                            <div class="glass-light rounded-lg p-2"><span class="quality-badge quality-B">B</span><p class="mt-1">Dati parziali</p></div>
                            <div class="glass-light rounded-lg p-2"><span class="quality-badge quality-C">C</span><p class="mt-1">Stima</p></div>
                        </div>
                    </div>

                    <button onclick="loadAllMatches()" class="w-full gradient-primary py-4 rounded-xl font-bold text-white flex items-center justify-center gap-2 glow" ${state.loading ? 'disabled' : ''}>
                        ${state.loading ? '<span class="loader w-5 h-5 border-2 border-white border-t-transparent rounded-full"></span>' : 'üìÖ'}
                        ${state.loading ? 'Caricamento...' : 'Carica Palinsesto Completo'}
                    </button>
                    <p class="text-xs text-gray-500 text-center mt-2">9 campionati ‚Ä¢ Tutte le partite</p>
                `;
            }

            // MATCHES VIEW
            if (state.view === 'matches') {
                content = `
                    <button onclick="state.view='main';render()" class="flex items-center gap-2 text-gray-400 mb-4">‚Üê Indietro</button>

                    <!-- Filtri -->
                    <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
                        ${['today', 'tomorrow', 'week', 'all'].map(f => `
                            <button onclick="state.dateFilter='${f}';filterMatches();render()" class="px-4 py-2 rounded-xl text-sm font-bold whitespace-nowrap ${state.dateFilter === f ? 'gradient-primary text-white' : 'glass-light'}">
                                ${f === 'today' ? 'Oggi' : f === 'tomorrow' ? 'Domani' : f === 'week' ? '7 giorni' : 'Tutte'}
                            </button>
                        `).join('')}
                    </div>

                    <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
                        <button onclick="state.selectedLeague='ALL';filterMatches();render()" class="px-3 py-2 rounded-xl text-xs font-bold whitespace-nowrap ${state.selectedLeague === 'ALL' ? 'gradient-primary text-white' : 'glass-light'}">üåç Tutti</button>
                        ${Object.entries(LEAGUES).map(([code, l]) => `
                            <button onclick="state.selectedLeague='${code}';filterMatches();render()" class="px-3 py-2 rounded-xl text-xs font-bold whitespace-nowrap ${state.selectedLeague === code ? 'gradient-primary text-white' : 'glass-light'}">${l.flag}</button>
                        `).join('')}
                    </div>

                    <p class="text-sm text-gray-400 mb-3">${state.filteredMatches.length} partite</p>

                    ${state.filteredMatches.length === 0 ? `
                        <div class="glass rounded-2xl p-12 text-center">
                            <p class="text-gray-400">Nessuna partita</p>
                        </div>
                    ` : `
                        <div class="space-y-3 max-h-[60vh] overflow-y-auto">
                            ${state.filteredMatches.slice(0, 50).map((m, i) => {
                                const dt = formatDate(m.utcDate);
                                const home = m.homeTeam.shortName || m.homeTeam.name;
                                const away = m.awayTeam.shortName || m.awayTeam.name;
                                const ld = LEAGUES[m.leagueCode] || {};
                                const homeStats = getTeamStats(home);
                                const awayStats = getTeamStats(away);
                                const quality = homeStats.found && awayStats.found ? 'A' : (homeStats.found || awayStats.found ? 'B' : 'C');
                                
                                return `
                                    <div onclick="selectMatch(${i})" class="glass match-card rounded-2xl p-4 cursor-pointer fade-in">
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="flex items-center gap-2">
                                                <span class="text-xs">${ld.flag || '‚öΩ'}</span>
                                                <span class="text-xs text-emerald-400">${ld.name || ''}</span>
                                                <span class="quality-badge quality-${quality}">${quality}</span>
                                            </div>
                                            <span class="text-xs text-gray-500">${dt.date} ${dt.time}</span>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center gap-2 flex-1">
                                                ${m.homeTeam.crest ? `<img src="${m.homeTeam.crest}" class="w-7 h-7"/>` : ''}
                                                <span class="font-bold text-sm">${home}</span>
                                            </div>
                                            <span class="text-gray-500 px-2 text-xs">vs</span>
                                            <div class="flex items-center gap-2 flex-1 justify-end">
                                                <span class="font-bold text-sm">${away}</span>
                                                ${m.awayTeam.crest ? `<img src="${m.awayTeam.crest}" class="w-7 h-7"/>` : ''}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `}
                `;
            }

            // ANALYSIS VIEW
            if (state.view === 'analysis' && state.selectedMatch) {
                const m = state.selectedMatch;
                const home = m.homeTeam.shortName || m.homeTeam.name;
                const away = m.awayTeam.shortName || m.awayTeam.name;
                const matchInfo = esc(`${home} vs ${away}`);
                const dt = formatDate(m.utcDate);
                const ld = LEAGUES[m.leagueCode] || {};
                const a = state.analysisData;

                content = `
                    <button onclick="state.view='matches';state.analysisData=null;render()" class="flex items-center gap-2 text-gray-400 mb-4">‚Üê Partite</button>

                    <div class="glass rounded-2xl p-5 mb-4 glow-sm">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-2">
                                <span class="text-xs px-3 py-1 rounded-full bg-emerald-500/20 text-emerald-400 font-bold">${ld.flag || ''} ${ld.name || ''}</span>
                                <span class="quality-badge quality-${a.dataQuality}">${a.dataQuality}</span>
                            </div>
                            <span class="text-sm text-gray-400">${dt.date} ${dt.time}</span>
                        </div>
                        <div class="flex items-center justify-center gap-4">
                            <div class="text-center flex-1">
                                ${m.homeTeam.crest ? `<img src="${m.homeTeam.crest}" class="w-12 h-12 mx-auto mb-2"/>` : ''}
                                <p class="font-bold">${home}</p>
                                <p class="text-xs text-gray-500">üö© ${a.homeStats.corners}/g ‚Ä¢ üü® ${a.homeStats.cards}/g</p>
                            </div>
                            <div class="w-12 h-12 gradient-primary rounded-full flex items-center justify-center font-black">VS</div>
                            <div class="text-center flex-1">
                                ${m.awayTeam.crest ? `<img src="${m.awayTeam.crest}" class="w-12 h-12 mx-auto mb-2"/>` : ''}
                                <p class="font-bold">${away}</p>
                                <p class="text-xs text-gray-500">üö© ${a.awayStats.corners}/g ‚Ä¢ üü® ${a.awayStats.cards}/g</p>
                            </div>
                        </div>
                    </div>

                    <!-- GG/NG -->
                    <div class="glass rounded-2xl p-5 mb-4">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 gradient-primary rounded-xl flex items-center justify-center">‚öΩ</div>
                            <div>
                                <h3 class="font-bold">GG / NG</h3>
                                <p class="text-xs text-gray-500">GG Rate: ${a.homeStats.ggRate}% + ${a.awayStats.ggRate}%</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="savePrediction('${matchInfo}', 'GG', 'GG', ${a.gg.conf}, '${a.gg.quality}')" class="pick-btn glass-light rounded-xl p-4 text-center ${a.gg.prob > 52 ? 'recommended' : ''}">
                                <p class="font-black text-2xl">GG</p>
                                <p class="text-gray-400 text-sm">${a.gg.prob.toFixed(0)}%</p>
                                <div class="flex items-center justify-center gap-2 mt-2">
                                    <span class="px-3 py-1 rounded-lg text-xs font-bold ${confClass(a.gg.conf)}">${a.gg.conf.toFixed(0)}%</span>
                                    <span class="quality-badge quality-${a.gg.quality}">${a.gg.quality}</span>
                                </div>
                            </button>
                            <button onclick="savePrediction('${matchInfo}', 'GG', 'NG', ${100 - a.gg.conf}, '${a.gg.quality}')" class="pick-btn glass-light rounded-xl p-4 text-center ${a.gg.prob <= 52 ? 'recommended' : ''}">
                                <p class="font-black text-2xl">NG</p>
                                <p class="text-gray-400 text-sm">${(100 - a.gg.prob).toFixed(0)}%</p>
                                <div class="flex items-center justify-center gap-2 mt-2">
                                    <span class="px-3 py-1 rounded-lg text-xs font-bold ${confClass(100 - a.gg.conf)}">${(100 - a.gg.conf).toFixed(0)}%</span>
                                </div>
                            </button>
                        </div>
                    </div>

                    <!-- CORNERS -->
                    <div class="glass rounded-2xl p-5 mb-4">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-xl flex items-center justify-center">üö©</div>
                                <div>
                                    <h3 class="font-bold">Corner</h3>
                                    <p class="text-xs text-gray-500">Exp: ${a.corners.total.toFixed(1)}</p>
                                </div>
                            </div>
                        </div>
                        
                        <p class="text-sm font-bold text-gray-400 mb-2">üìä Totale</p>
                        <div class="grid grid-cols-2 gap-2 mb-4">
                            ${Object.entries(a.corners.preds).map(([line, p]) => `
                                <button onclick="savePrediction('${matchInfo}', 'Corner', '${p.pick} ${line}', ${p.conf}, '${p.quality}')" class="pick-btn glass-light rounded-xl p-3 flex items-center justify-between ${p.conf >= 60 ? 'recommended' : ''}">
                                    <span class="font-bold">${p.pick} ${line}</span>
                                    <div class="flex items-center gap-1">
                                        <span class="px-2 py-1 rounded text-xs font-bold ${confClass(p.conf)}">${p.conf.toFixed(0)}%</span>
                                        <span class="quality-badge quality-${p.quality}">${p.quality}</span>
                                    </div>
                                </button>
                            `).join('')}
                        </div>

                        <p class="text-sm font-bold text-gray-400 mb-2">üè† ${home} (${a.corners.home.toFixed(1)})</p>
                        <div class="grid grid-cols-3 gap-2 mb-4">
                            ${Object.entries(a.corners.homePreds).map(([line, p]) => `
                                <button onclick="savePrediction('${matchInfo}', 'Corner Casa', '${p.pick} ${line}', ${p.conf}, '${p.quality}')" class="pick-btn glass-light rounded-xl p-2 text-center">
                                    <p class="font-bold text-sm">${p.pick} ${line}</p>
                                    <span class="text-xs ${p.conf >= 58 ? 'text-emerald-400' : 'text-yellow-400'}">${p.conf.toFixed(0)}%</span>
                                </button>
                            `).join('')}
                        </div>

                        <p class="text-sm font-bold text-gray-400 mb-2">üöå ${away} (${a.corners.away.toFixed(1)})</p>
                        <div class="grid grid-cols-3 gap-2">
                            ${Object.entries(a.corners.awayPreds).map(([line, p]) => `
                                <button onclick="savePrediction('${matchInfo}', 'Corner Ospite', '${p.pick} ${line}', ${p.conf}, '${p.quality}')" class="pick-btn glass-light rounded-xl p-2 text-center">
                                    <p class="font-bold text-sm">${p.pick} ${line}</p>
                                    <span class="text-xs ${p.conf >= 58 ? 'text-emerald-400' : 'text-yellow-400'}">${p.conf.toFixed(0)}%</span>
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <!-- CARDS -->
                    <div class="glass rounded-2xl p-5 mb-4">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-gradient-to-br from-red-400 to-pink-500 rounded-xl flex items-center justify-center">üü®</div>
                                <div>
                                    <h3 class="font-bold">Cartellini</h3>
                                    <p class="text-xs text-gray-500">Exp: ${a.cards.total.toFixed(1)}</p>
                                </div>
                            </div>
                        </div>
                        
                        <p class="text-sm font-bold text-gray-400 mb-2">üìä Totale</p>
                        <div class="grid grid-cols-2 gap-2 mb-4">
                            ${Object.entries(a.cards.preds).map(([line, p]) => `
                                <button onclick="savePrediction('${matchInfo}', 'Cards', '${p.pick} ${line}', ${p.conf}, '${p.quality}')" class="pick-btn glass-light rounded-xl p-3 flex items-center justify-between ${p.conf >= 58 ? 'recommended' : ''}">
                                    <span class="font-bold">${p.pick} ${line}</span>
                                    <div class="flex items-center gap-1">
                                        <span class="px-2 py-1 rounded text-xs font-bold ${confClass(p.conf)}">${p.conf.toFixed(0)}%</span>
                                        <span class="quality-badge quality-${p.quality}">${p.quality}</span>
                                    </div>
                                </button>
                            `).join('')}
                        </div>

                        <p class="text-sm font-bold text-gray-400 mb-2">üè† ${home} (${a.cards.home.toFixed(1)})</p>
                        <div class="grid grid-cols-2 gap-2 mb-4">
                            ${Object.entries(a.cards.homePreds).map(([line, p]) => `
                                <button onclick="savePrediction('${matchInfo}', 'Cards Casa', '${p.pick} ${line}', ${p.conf}, '${p.quality}')" class="pick-btn glass-light rounded-xl p-2 text-center">
                                    <p class="font-bold text-sm">${p.pick} ${line}</p>
                                    <span class="text-xs ${p.conf >= 55 ? 'text-emerald-400' : 'text-yellow-400'}">${p.conf.toFixed(0)}%</span>
                                </button>
                            `).join('')}
                        </div>

                        <p class="text-sm font-bold text-gray-400 mb-2">üöå ${away} (${a.cards.away.toFixed(1)})</p>
                        <div class="grid grid-cols-2 gap-2">
                            ${Object.entries(a.cards.awayPreds).map(([line, p]) => `
                                <button onclick="savePrediction('${matchInfo}', 'Cards Ospite', '${p.pick} ${line}', ${p.conf}, '${p.quality}')" class="pick-btn glass-light rounded-xl p-2 text-center">
                                    <p class="font-bold text-sm">${p.pick} ${line}</p>
                                    <span class="text-xs ${p.conf >= 55 ? 'text-emerald-400' : 'text-yellow-400'}">${p.conf.toFixed(0)}%</span>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // HISTORY VIEW
            if (state.view === 'history') {
                content = renderHistory();
            }

            // PROFILE VIEW
            if (state.view === 'profile') {
                content = `
                    <div class="glass rounded-2xl p-6 mb-6 text-center">
                        <div class="w-20 h-20 gradient-primary rounded-full flex items-center justify-center mx-auto mb-4">üë§</div>
                        <h2 class="font-bold text-xl">${state.user?.displayName || 'Utente'}</h2>
                        <p class="text-gray-400 text-sm">${state.user?.email}</p>
                    </div>
                    <div class="glass rounded-2xl p-5 mb-6">
                        <h3 class="font-bold mb-4">üìä Stats</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="glass-light rounded-xl p-4 text-center">
                                <p class="text-3xl font-black gradient-text">${hitRate}%</p>
                                <p class="text-xs text-gray-400">Hit Rate</p>
                            </div>
                            <div class="glass-light rounded-xl p-4 text-center">
                                <p class="text-3xl font-black">${state.stats.total}</p>
                                <p class="text-xs text-gray-400">Totali</p>
                            </div>
                        </div>
                    </div>
                    <button onclick="state.view='setup';render()" class="w-full glass-light rounded-xl p-4 text-left mb-3">üîë Modifica API Key</button>
                    <button onclick="signOut()" class="w-full py-4 rounded-xl border border-red-500/50 text-red-400 font-bold">üö™ Logout</button>
                `;
            }

            return `
                <div class="max-w-lg mx-auto min-h-screen flex flex-col pb-24">
                    <header class="glass sticky top-0 z-50 px-4 py-3 border-b border-white/10">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 gradient-primary rounded-xl flex items-center justify-center glow-sm">‚öΩ</div>
                                <div>
                                    <h1 class="font-black">BOMBA BET</h1>
                                    <p class="text-xs text-gray-500">PRO V2</p>
                                </div>
                            </div>
                            <span class="text-xs text-emerald-400 font-bold px-2 py-1 rounded-full bg-emerald-500/20">${hitRate}%</span>
                        </div>
                    </header>
                    <main class="flex-1 p-4">${content}</main>
                    <nav class="fixed bottom-0 left-0 right-0 glass border-t border-white/10 z-50">
                        <div class="max-w-lg mx-auto flex">
                            <button onclick="state.view='main';render()" class="nav-item flex-1 py-4 flex flex-col items-center gap-1 ${['main','matches','analysis'].includes(state.view) ? 'active' : 'text-gray-500'}">
                                <span class="text-xl">üìä</span><span class="text-xs">Analisi</span>
                            </button>
                            <button onclick="state.view='history';loadHistoryView()" class="nav-item flex-1 py-4 flex flex-col items-center gap-1 ${state.view === 'history' ? 'active' : 'text-gray-500'}">
                                <span class="text-xl">üìù</span><span class="text-xs">Storico</span>
                            </button>
                            <button onclick="state.view='profile';render()" class="nav-item flex-1 py-4 flex flex-col items-center gap-1 ${state.view === 'profile' ? 'active' : 'text-gray-500'}">
                                <span class="text-xl">üë§</span><span class="text-xs">Profilo</span>
                            </button>
                        </div>
                    </nav>
                </div>
            `;
        }

        async function loadHistoryView() {
            state.view = 'history';
            state.loading = true;
            render();
            state.predictions = await loadPredictions();
            state.loading = false;
            render();
        }

        function renderHistory() {
            if (state.loading) return `<div class="glass rounded-2xl p-12 text-center"><div class="w-12 h-12 border-4 border-emerald-500 border-t-transparent rounded-full loader mx-auto"></div></div>`;
            
            return `
                <h2 class="font-bold text-lg mb-4">üìù Storico</h2>
                ${state.predictions.length === 0 ? `<div class="glass rounded-2xl p-12 text-center"><p class="text-gray-400">Nessun pronostico</p></div>` : `
                    <div class="space-y-3">
                        ${state.predictions.map(p => {
                            const icon = p.pickType?.includes('Corner') ? 'üö©' : p.pickType?.includes('Card') ? 'üü®' : '‚öΩ';
                            const bgClass = p.result === 'won' ? 'result-won' : p.result === 'lost' ? 'result-lost' : '';
                            return `
                                <div class="glass rounded-2xl p-4 border ${bgClass} fade-in">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-2 mb-1">
                                                <span class="text-xl">${icon}</span>
                                                <span class="font-bold">${p.matchInfo}</span>
                                                ${p.quality ? `<span class="quality-badge quality-${p.quality}">${p.quality}</span>` : ''}
                                            </div>
                                            <p class="text-emerald-400 font-semibold">${p.pickType}: ${p.pickValue}</p>
                                            <div class="flex items-center gap-2 mt-2">
                                                <span class="px-2 py-1 rounded text-xs font-bold ${confClass(p.confidence)}">${p.confidence}%</span>
                                                <span class="text-xs text-gray-500">${new Date(p.createdAt).toLocaleDateString('it-IT')}</span>
                                            </div>
                                        </div>
                                        <div class="ml-4">
                                            ${p.result === null ? `
                                                <div class="flex flex-col gap-2">
                                                    <button onclick="updatePredictionResult('${p.id}','won')" class="px-3 py-2 rounded-lg bg-emerald-500/20 text-emerald-400 font-bold text-sm">‚úì</button>
                                                    <button onclick="updatePredictionResult('${p.id}','lost')" class="px-3 py-2 rounded-lg bg-red-500/20 text-red-400 font-bold text-sm">‚úó</button>
                                                </div>
                                            ` : `<span class="text-3xl">${p.result === 'won' ? '‚úÖ' : '‚ùå'}</span>`}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `}
            `;
        }

        // Global Functions
        let isRegisterMode = false;
        function toggleAuthMode() {
            isRegisterMode = !isRegisterMode;
            state.error = null;
            const nameInput = document.getElementById('nameInput');
            if (nameInput) nameInput.classList.toggle('hidden');
            render();
        }

        function handleEmailAuth() {
            const email = document.getElementById('emailInput')?.value.trim();
            const password = document.getElementById('passwordInput')?.value;
            const name = document.getElementById('nameInput')?.value.trim() || '';
            if (!email || !password) { state.error = 'Compila tutti i campi'; render(); return; }
            if (isRegisterMode) signUpWithEmail(email, password, name);
            else signInWithEmail(email, password);
        }

        function saveApiKey() {
            const key = document.getElementById('apiKeyInput')?.value.trim();
            if (key) { localStorage.setItem('bombaBetApiKey', key); state.apiKey = key; state.view = 'main'; render(); }
        }

        function selectMatch(index) {
            const m = state.filteredMatches[index];
            state.selectedMatch = m;
            const home = m.homeTeam.shortName || m.homeTeam.name;
            const away = m.awayTeam.shortName || m.awayTeam.name;
            state.analysisData = analyzeAdvanced(home, away, m.leagueCode);
            state.view = 'analysis';
            render();
        }

        // Init
        render();
    </script>
</body>
</html>
