<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ BOMBA BET PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        * { font-family: 'Outfit', sans-serif; box-sizing: border-box; }
        
        :root {
            --bg-primary: #0f0f1a;
            --bg-card: rgba(26, 26, 46, 0.8);
            --accent-green: #00f5a0;
            --accent-blue: #00d9f5;
        }
        
        body { 
            background: linear-gradient(135deg, var(--bg-primary) 0%, #16162a 50%, var(--bg-primary) 100%);
            color: #fff; 
            min-height: 100vh;
        }
        
        .glass { 
            background: var(--bg-card); 
            backdrop-filter: blur(20px); 
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 16px;
        }
        
        .glass-strong {
            background: linear-gradient(135deg, rgba(0,245,160,0.1) 0%, rgba(0,217,245,0.05) 100%);
            border: 1px solid rgba(0,245,160,0.2);
            border-radius: 20px;
        }
        
        .glow-green { box-shadow: 0 0 40px rgba(0,245,160,0.2); }
        
        .gradient-text { 
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue)); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
        }
        
        .gradient-btn {
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            transition: all 0.3s ease;
        }
        .gradient-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0,245,160,0.3);
        }
        
        .loader { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .slide-up { animation: slideUp 0.4s ease-out forwards; opacity: 0; }
        @keyframes slideUp { 
            from { transform: translateY(30px); opacity: 0; } 
            to { transform: translateY(0); opacity: 1; } 
        }
        
        .match-card { 
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .match-card:hover { 
            transform: translateY(-4px);
            border-color: rgba(0,245,160,0.3);
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        
        .pick-card {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 12px;
            transition: all 0.2s ease;
        }
        .pick-card:hover { border-color: rgba(0,245,160,0.3); }
        .pick-card.selected { border-color: rgba(0,245,160,0.5); background: rgba(0,245,160,0.1); }
        
        .conf-badge {
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
        }
        .conf-high { background: rgba(0,245,160,0.2); color: #00f5a0; }
        .conf-mid { background: rgba(245,200,0,0.2); color: #f5c800; }
        .conf-low { background: rgba(255,107,53,0.2); color: #ff6b35; }
        
        .result-won { background: rgba(0,245,160,0.1); border-color: rgba(0,245,160,0.3); }
        .result-lost { background: rgba(255,107,53,0.1); border-color: rgba(255,107,53,0.3); }
        
        .stat-badge {
            background: linear-gradient(135deg, rgba(0,245,160,0.2), rgba(0,217,245,0.1));
            border: 1px solid rgba(0,245,160,0.3);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        select, input { 
            background: rgba(255,255,255,0.05); 
            border: 1px solid rgba(255,255,255,0.1); 
            color: white; 
            border-radius: 12px;
            padding: 10px 14px;
        }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--accent-green); border-radius: 3px; }
        
        button:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body>
    <div id="app" class="max-w-lg mx-auto min-h-screen flex flex-col pb-24"></div>

    <script>
        // ============================================================
        // üéØ BOMBA BET V10 - SPORTAPI7 EDITION
        // ============================================================
        // ‚úÖ SportAPI7 (RapidAPI) - Funzionante
        // ‚úÖ Solo Calcio: GG, Corner, Cards
        // ‚úÖ Corner/Cards: Totale + Casa + Ospite
        // ‚úÖ Storico con WIN/LOST
        // ‚úÖ Grafica Premium
        // ============================================================

        // API Config - SportAPI7
        const RAPIDAPI_HOST = "sportapi7.p.rapidapi.com";
        const API_BASE = "/api/v1";
        
        const ENDPOINTS = {
            scheduledEvents: (sport, date) => `${API_BASE}/sport/${sport}/scheduled-events/${date}`,
            event: (eventId) => `${API_BASE}/event/${eventId}`,
        };

        // Key in localStorage
        let RAPIDAPI_KEY = localStorage.getItem("RAPIDAPI_KEY") || "";

        // ============================================================
        // üìä DATABASE STATISTICHE SQUADRE (Algoritmo Migliorato)
        // ============================================================
        
        const TEAM_STATS = {
            // SERIE A
            'Juventus': { corners: 5.8, cornersAg: 4.2, cards: 2.1, cardsAg: 1.8, ggRate: 48 },
            'Inter': { corners: 6.2, cornersAg: 3.8, cards: 1.9, cardsAg: 2.0, ggRate: 55 },
            'Milan': { corners: 5.5, cornersAg: 4.5, cards: 2.3, cardsAg: 1.9, ggRate: 58 },
            'AC Milan': { corners: 5.5, cornersAg: 4.5, cards: 2.3, cardsAg: 1.9, ggRate: 58 },
            'Napoli': { corners: 5.9, cornersAg: 4.0, cards: 2.0, cardsAg: 2.1, ggRate: 55 },
            'Roma': { corners: 5.3, cornersAg: 4.8, cards: 2.4, cardsAg: 2.0, ggRate: 52 },
            'AS Roma': { corners: 5.3, cornersAg: 4.8, cards: 2.4, cardsAg: 2.0, ggRate: 52 },
            'Lazio': { corners: 5.4, cornersAg: 4.6, cards: 2.2, cardsAg: 2.2, ggRate: 60 },
            'Atalanta': { corners: 6.0, cornersAg: 4.1, cards: 2.1, cardsAg: 1.8, ggRate: 65 },
            'Fiorentina': { corners: 5.2, cornersAg: 4.9, cards: 2.3, cardsAg: 2.1, ggRate: 55 },
            'Bologna': { corners: 5.1, cornersAg: 5.0, cards: 2.0, cardsAg: 2.3, ggRate: 50 },
            'Torino': { corners: 4.8, cornersAg: 5.2, cards: 2.4, cardsAg: 2.0, ggRate: 52 },
            'Monza': { corners: 4.5, cornersAg: 5.5, cards: 2.2, cardsAg: 2.1, ggRate: 48 },
            'Udinese': { corners: 4.6, cornersAg: 5.3, cards: 2.3, cardsAg: 2.0, ggRate: 45 },
            'Genoa': { corners: 4.4, cornersAg: 5.6, cards: 2.5, cardsAg: 1.9, ggRate: 42 },
            'Cagliari': { corners: 4.3, cornersAg: 5.7, cards: 2.4, cardsAg: 2.2, ggRate: 48 },
            'Empoli': { corners: 4.2, cornersAg: 5.8, cards: 2.1, cardsAg: 2.3, ggRate: 40 },
            'Parma': { corners: 4.5, cornersAg: 5.5, cards: 2.2, cardsAg: 2.1, ggRate: 50 },
            'Verona': { corners: 4.4, cornersAg: 5.6, cards: 2.3, cardsAg: 2.0, ggRate: 52 },
            'Hellas Verona': { corners: 4.4, cornersAg: 5.6, cards: 2.3, cardsAg: 2.0, ggRate: 52 },
            'Como': { corners: 4.3, cornersAg: 5.7, cards: 2.0, cardsAg: 2.2, ggRate: 45 },
            'Lecce': { corners: 4.1, cornersAg: 5.9, cards: 2.4, cardsAg: 2.1, ggRate: 38 },
            'Venezia': { corners: 4.0, cornersAg: 6.0, cards: 2.2, cardsAg: 2.3, ggRate: 42 },
            // PREMIER LEAGUE
            'Manchester City': { corners: 7.2, cornersAg: 3.1, cards: 1.5, cardsAg: 1.8, ggRate: 48 },
            'Arsenal': { corners: 6.5, cornersAg: 3.8, cards: 1.7, cardsAg: 1.9, ggRate: 52 },
            'Liverpool': { corners: 6.8, cornersAg: 3.5, cards: 1.6, cardsAg: 2.0, ggRate: 58 },
            'Chelsea': { corners: 5.8, cornersAg: 4.2, cards: 1.9, cardsAg: 1.8, ggRate: 55 },
            'Manchester United': { corners: 5.5, cornersAg: 4.8, cards: 2.0, cardsAg: 1.7, ggRate: 58 },
            'Tottenham': { corners: 5.9, cornersAg: 4.5, cards: 1.8, cardsAg: 2.1, ggRate: 62 },
            'Newcastle': { corners: 5.6, cornersAg: 4.6, cards: 1.9, cardsAg: 1.9, ggRate: 52 },
            'Aston Villa': { corners: 5.4, cornersAg: 4.8, cards: 2.0, cardsAg: 1.8, ggRate: 58 },
            'Brighton': { corners: 5.3, cornersAg: 4.7, cards: 1.8, cardsAg: 2.0, ggRate: 55 },
            'West Ham': { corners: 5.0, cornersAg: 5.0, cards: 2.1, cardsAg: 1.9, ggRate: 52 },
            // LA LIGA
            'Real Madrid': { corners: 6.8, cornersAg: 3.2, cards: 2.0, cardsAg: 2.4, ggRate: 50 },
            'Barcelona': { corners: 7.0, cornersAg: 3.0, cards: 1.8, cardsAg: 2.5, ggRate: 55 },
            'Atletico Madrid': { corners: 5.2, cornersAg: 4.0, cards: 2.8, cardsAg: 2.2, ggRate: 42 },
            // BUNDESLIGA
            'Bayern Munich': { corners: 7.5, cornersAg: 2.8, cards: 1.4, cardsAg: 1.9, ggRate: 62 },
            'Bayern': { corners: 7.5, cornersAg: 2.8, cards: 1.4, cardsAg: 1.9, ggRate: 62 },
            'Bayer Leverkusen': { corners: 6.8, cornersAg: 3.2, cards: 1.6, cardsAg: 1.8, ggRate: 55 },
            'Leverkusen': { corners: 6.8, cornersAg: 3.2, cards: 1.6, cardsAg: 1.8, ggRate: 55 },
            'Borussia Dortmund': { corners: 6.2, cornersAg: 4.0, cards: 1.7, cardsAg: 1.7, ggRate: 65 },
            'Dortmund': { corners: 6.2, cornersAg: 4.0, cards: 1.7, cardsAg: 1.7, ggRate: 65 },
            // LIGUE 1
            'PSG': { corners: 7.8, cornersAg: 2.5, cards: 1.6, cardsAg: 2.2, ggRate: 45 },
            'Paris Saint Germain': { corners: 7.8, cornersAg: 2.5, cards: 1.6, cardsAg: 2.2, ggRate: 45 },
            'Monaco': { corners: 5.8, cornersAg: 4.2, cards: 1.9, cardsAg: 2.0, ggRate: 58 },
            'Marseille': { corners: 5.5, cornersAg: 4.6, cards: 2.2, cardsAg: 2.1, ggRate: 55 },
            'Lyon': { corners: 5.6, cornersAg: 4.5, cards: 2.0, cardsAg: 2.2, ggRate: 58 },
        };

        // ============================================================
        // STATE
        // ============================================================

        const state = {
            view: 'main',
            date: new Date().toISOString().slice(0, 10),
            loading: false,
            error: null,
            matches: [],
            selectedMatch: null,
            history: JSON.parse(localStorage.getItem('bombaBetHistory') || '[]'),
        };

        // ============================================================
        // API FUNCTIONS
        // ============================================================

        const MIN_GAP_MS = 650;
        let _lastReqTs = 0;

        async function throttle() {
            const now = Date.now();
            const wait = Math.max(0, MIN_GAP_MS - (now - _lastReqTs));
            if (wait > 0) await new Promise(r => setTimeout(r, wait));
            _lastReqTs = Date.now();
        }

        async function fetchWith429Retry(url, options, maxRetries = 4) {
            let last = null;
            for (let attempt = 0; attempt <= maxRetries; attempt++) {
                await throttle();
                const res = await fetch(url, options);
                last = res;
                if (res.status !== 429) return res;
                const backoffMs = Math.round(900 * Math.pow(2, attempt));
                await new Promise(r => setTimeout(r, backoffMs));
            }
            return last;
        }

        async function apiGet(path) {
            if (!RAPIDAPI_KEY) throw new Error("API Key mancante");
            const url = `https://${RAPIDAPI_HOST}${path}`;
            
            const res = await fetchWith429Retry(url, {
                method: "GET",
                headers: {
                    "X-RapidAPI-Key": RAPIDAPI_KEY,
                    "X-RapidAPI-Host": RAPIDAPI_HOST,
                }
            });

            if (!res?.ok) {
                throw new Error(`HTTP ${res ? res.status : "?"}`);
            }

            return await res.json();
        }

        // ============================================================
        // ANALISI ALGORITMO
        // ============================================================

        function getTeamStats(name) {
            if (!name) return { corners: 5.0, cornersAg: 5.0, cards: 2.0, cardsAg: 2.0, ggRate: 50 };
            const n = name.toLowerCase();
            for (const [k, v] of Object.entries(TEAM_STATS)) {
                if (n.includes(k.toLowerCase()) || k.toLowerCase().includes(n)) return v;
            }
            return { corners: 5.0, cornersAg: 5.0, cards: 2.0, cardsAg: 2.0, ggRate: 50 };
        }

        function analyzeMatch(home, away) {
            const h = getTeamStats(home);
            const a = getTeamStats(away);

            // GG Analysis
            const avgGGRate = (h.ggRate + a.ggRate) / 2;
            const ggProb = Math.max(30, Math.min(75, avgGGRate));
            const ggConf = 45 + Math.abs(ggProb - 50) * 0.8;

            // Corner Analysis
            const homeCornersExp = (h.corners * 1.08 + a.cornersAg * 0.92) / 2;
            const awayCornersExp = (a.corners * 0.92 + h.cornersAg * 1.08) / 2;
            const totalCornersExp = homeCornersExp + awayCornersExp;

            const cornerPreds = [8.5, 9.5, 10.5, 11.5].map(line => ({
                line,
                pick: totalCornersExp > line ? 'OVER' : 'UNDER',
                conf: Math.min(85, 50 + Math.abs(totalCornersExp - line) * 9)
            }));

            const homeCornerPreds = [3.5, 4.5, 5.5].map(line => ({
                line,
                pick: homeCornersExp > line ? 'OVER' : 'UNDER',
                conf: Math.min(80, 48 + Math.abs(homeCornersExp - line) * 12)
            }));
            
            const awayCornerPreds = [3.5, 4.5, 5.5].map(line => ({
                line,
                pick: awayCornersExp > line ? 'OVER' : 'UNDER',
                conf: Math.min(80, 48 + Math.abs(awayCornersExp - line) * 12)
            }));

            // Cards Analysis
            const homeCardsExp = (h.cards * 0.9 + a.cardsAg * 1.1) / 2;
            const awayCardsExp = (a.cards * 1.1 + h.cardsAg * 0.9) / 2;
            const totalCardsExp = homeCardsExp + awayCardsExp;

            const cardPreds = [3.5, 4.5, 5.5].map(line => ({
                line,
                pick: totalCardsExp > line ? 'OVER' : 'UNDER',
                conf: Math.min(82, 48 + Math.abs(totalCardsExp - line) * 11)
            }));

            const homeCardPreds = [1.5, 2.5].map(line => ({
                line,
                pick: homeCardsExp > line ? 'OVER' : 'UNDER',
                conf: Math.min(78, 46 + Math.abs(homeCardsExp - line) * 14)
            }));
            
            const awayCardPreds = [1.5, 2.5].map(line => ({
                line,
                pick: awayCardsExp > line ? 'OVER' : 'UNDER',
                conf: Math.min(78, 46 + Math.abs(awayCardsExp - line) * 14)
            }));

            return {
                gg: { prob: ggProb, conf: ggConf },
                corners: { total: totalCornersExp, home: homeCornersExp, away: awayCornersExp, preds: cornerPreds, homePreds: homeCornerPreds, awayPreds: awayCornerPreds },
                cards: { total: totalCardsExp, home: homeCardsExp, away: awayCardsExp, preds: cardPreds, homePreds: homeCardPreds, awayPreds: awayCardPreds }
            };
        }

        // ============================================================
        // HISTORY
        // ============================================================

        function saveHistory() {
            localStorage.setItem('bombaBetHistory', JSON.stringify(state.history));
        }

        function addToHistory(matchInfo, pickType, pickValue, conf) {
            state.history.unshift({
                id: Date.now(),
                matchInfo,
                pickType,
                pickValue,
                conf: Math.round(conf),
                result: null,
                date: new Date().toISOString()
            });
            saveHistory();
            showToast('‚úÖ Salvato!');
            render();
        }

        function updateResult(id, result) {
            const entry = state.history.find(e => e.id === id);
            if (entry) {
                entry.result = result;
                saveHistory();
                render();
            }
        }

        function getStats() {
            const resolved = state.history.filter(e => e.result);
            const won = resolved.filter(e => e.result === 'won').length;
            return { total: state.history.length, won, lost: resolved.length - won, hitRate: resolved.length ? (won / resolved.length * 100).toFixed(1) : 0 };
        }

        function showToast(msg) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-24 left-1/2 transform -translate-x-1/2 bg-gradient-to-r from-green-500 to-cyan-500 text-black px-6 py-3 rounded-full font-bold z-50 slide-up';
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        // ============================================================
        // LOAD MATCHES
        // ============================================================

        async function loadMatches() {
            if (!RAPIDAPI_KEY) { promptKey(); return; }

            state.loading = true;
            state.error = null;
            state.matches = [];
            render();

            try {
                const data = await apiGet(ENDPOINTS.scheduledEvents('football', state.date));
                const events = data?.events || data?.response || data?.data || [];
                
                if (Array.isArray(events) && events.length > 0) {
                    state.matches = events
                        .map(ev => ({
                            id: ev?.id ?? ev?.event?.id,
                            home: ev?.homeTeam?.name || ev?.home?.name || 'Home',
                            away: ev?.awayTeam?.name || ev?.away?.name || 'Away',
                            tournament: ev?.tournament?.name || ev?.league?.name || '‚Äî',
                            startTs: ev?.startTimestamp || ev?.startTime,
                            homeLogo: ev?.homeTeam?.logo || null,
                            awayLogo: ev?.awayTeam?.logo || null,
                        }))
                        .filter(m => m.id)
                        .sort((a, b) => (a.startTs || 0) - (b.startTs || 0));
                    
                    state.view = 'matches';
                } else {
                    state.error = 'Nessun evento trovato';
                }
            } catch (e) {
                state.error = e.message;
            }

            state.loading = false;
            render();
        }

        function promptKey() {
            const k = prompt("Incolla la tua RapidAPI Key:", RAPIDAPI_KEY || "");
            if (k) {
                RAPIDAPI_KEY = k.trim();
                localStorage.setItem("RAPIDAPI_KEY", RAPIDAPI_KEY);
                showToast('‚úÖ Key salvata!');
            }
        }

        // ============================================================
        // RENDER
        // ============================================================

        function escapeHtml(s) {
            return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
        }

        function confBadgeClass(v) {
            return v >= 65 ? 'conf-high' : v >= 52 ? 'conf-mid' : 'conf-low';
        }

        function fmtDate(tsSeconds) {
            if (!tsSeconds) return "--";
            const d = new Date(tsSeconds * 1000);
            return d.toLocaleString("it-IT", { weekday: "short", day: "2-digit", month: "2-digit", hour: "2-digit", minute: "2-digit" });
        }

        function renderMain() {
            return `
                <div class="p-4">
                    <div class="text-center mb-8 slide-up">
                        <div class="w-24 h-24 rounded-3xl bg-gradient-to-br from-green-400 to-cyan-500 flex items-center justify-center mx-auto mb-4 shadow-2xl">
                            <span class="text-5xl">‚öΩ</span>
                        </div>
                        <h1 class="text-4xl font-black gradient-text mb-2">BOMBA BET</h1>
                        <p class="text-gray-400">Analisi Calcistiche PRO</p>
                    </div>

                    <div class="glass p-4 mb-4 slide-up" style="animation-delay:0.1s">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="font-bold text-sm">üîë API Key</p>
                                <p class="text-xs text-gray-400">${RAPIDAPI_KEY ? 'Configurata ‚úì' : 'Non configurata'}</p>
                            </div>
                            <button onclick="promptKey()" class="glass px-4 py-2 rounded-xl text-sm font-bold hover:bg-white/10">
                                ${RAPIDAPI_KEY ? 'Modifica' : 'Imposta'}
                            </button>
                        </div>
                    </div>

                    <div class="glass p-4 mb-4 slide-up" style="animation-delay:0.15s">
                        <p class="font-bold text-sm mb-2">üìÖ Seleziona Data</p>
                        <input type="date" id="dateInput" value="${state.date}" class="w-full" />
                    </div>

                    <button onclick="loadMatches()" class="w-full gradient-btn py-4 rounded-2xl font-bold text-black text-lg mb-4 slide-up" style="animation-delay:0.2s" ${state.loading ? 'disabled' : ''}>
                        ${state.loading ? '‚è≥ Caricamento...' : 'üîÑ Carica Partite'}
                    </button>

                    ${state.error ? `<div class="glass p-4 text-red-400 text-center mb-4">${escapeHtml(state.error)}</div>` : ''}

                    <button onclick="state.view='history';render()" class="w-full glass py-4 rounded-2xl font-bold text-cyan-400 mb-4 slide-up" style="animation-delay:0.25s">
                        üìä Storico (${state.history.length})
                    </button>

                    <div class="grid grid-cols-3 gap-3 slide-up" style="animation-delay:0.3s">
                        <div class="glass p-4 text-center rounded-xl"><span class="text-2xl">‚öΩ</span><p class="text-xs text-gray-400 mt-2">GG</p></div>
                        <div class="glass p-4 text-center rounded-xl"><span class="text-2xl">üö©</span><p class="text-xs text-gray-400 mt-2">Corner</p></div>
                        <div class="glass p-4 text-center rounded-xl"><span class="text-2xl">üü®</span><p class="text-xs text-gray-400 mt-2">Cards</p></div>
                    </div>
                </div>
            `;
        }

        function renderMatches() {
            return `
                <div class="p-4">
                    <button onclick="state.view='main';render()" class="flex items-center gap-2 text-gray-400 mb-4 hover:text-white">‚Üê Indietro</button>
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold">üìÖ ${state.date}</h2>
                        <span class="stat-badge">${state.matches.length}</span>
                    </div>
                    ${state.loading ? `<div class="glass p-12 text-center"><div class="w-12 h-12 border-4 border-t-transparent border-cyan-400 rounded-full loader mx-auto"></div></div>` : `
                        <div class="space-y-3">
                            ${state.matches.map((m, i) => `
                                <div class="glass match-card p-4 slide-up" style="animation-delay:${i * 40}ms" onclick="selectMatch(${i})">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="stat-badge text-xs">${escapeHtml(m.tournament)}</span>
                                        <span class="text-xs text-gray-500">${fmtDate(m.startTs)}</span>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-2 flex-1">
                                            ${m.homeLogo ? `<img src="${escapeHtml(m.homeLogo)}" class="w-8 h-8 rounded"/>` : '<div class="w-8 h-8 rounded bg-white/10"></div>'}
                                            <span class="font-bold text-sm">${escapeHtml(m.home)}</span>
                                        </div>
                                        <span class="text-gray-500 px-3">vs</span>
                                        <div class="flex items-center gap-2 flex-1 justify-end">
                                            <span class="font-bold text-sm">${escapeHtml(m.away)}</span>
                                            ${m.awayLogo ? `<img src="${escapeHtml(m.awayLogo)}" class="w-8 h-8 rounded"/>` : '<div class="w-8 h-8 rounded bg-white/10"></div>'}
                                        </div>
                                    </div>
                                    <div class="text-center mt-2"><span class="text-xs text-cyan-400">Analisi ‚Üí</span></div>
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>
            `;
        }

        function renderAnalysis() {
            const m = state.selectedMatch;
            if (!m) return '';
            const analysis = analyzeMatch(m.home, m.away);
            const matchInfo = `${m.home} vs ${m.away}`;
            const safeMatch = escapeHtml(matchInfo).replace(/'/g, "\\'");

            return `
                <div class="p-4">
                    <button onclick="state.view='matches';state.selectedMatch=null;render()" class="flex items-center gap-2 text-gray-400 mb-4 hover:text-white">‚Üê Partite</button>

                    <div class="glass-strong p-6 mb-6 glow-green">
                        <div class="flex items-center justify-between mb-4">
                            <span class="stat-badge">${escapeHtml(m.tournament)}</span>
                            <span class="text-sm text-gray-400">${fmtDate(m.startTs)}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex-1 text-center">
                                <p class="font-bold">${escapeHtml(m.home)}</p>
                                <p class="text-xs text-gray-500">Casa</p>
                            </div>
                            <div class="w-12 h-12 rounded-full bg-gradient-to-br from-green-400 to-cyan-500 flex items-center justify-center mx-4">
                                <span class="text-black font-black">VS</span>
                            </div>
                            <div class="flex-1 text-center">
                                <p class="font-bold">${escapeHtml(m.away)}</p>
                                <p class="text-xs text-gray-500">Ospite</p>
                            </div>
                        </div>
                    </div>

                    <!-- GG -->
                    <div class="glass p-5 mb-4">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-green-400 to-cyan-500 flex items-center justify-center"><span class="text-lg">‚öΩ</span></div>
                            <div><h3 class="font-bold text-lg">GG / NG</h3></div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="pick-card text-center ${analysis.gg.prob > 52 ? 'selected' : ''}">
                                <p class="font-black text-2xl mb-1">GG</p>
                                <p class="text-sm text-gray-400 mb-2">${analysis.gg.prob.toFixed(0)}%</p>
                                <span class="conf-badge ${confBadgeClass(analysis.gg.conf)}">${analysis.gg.conf.toFixed(0)}%</span>
                                <button onclick="addToHistory('${safeMatch}', 'GG', 'GG', ${analysis.gg.conf})" class="mt-3 w-full py-2 rounded-lg gradient-btn text-black text-sm font-bold">üíæ</button>
                            </div>
                            <div class="pick-card text-center ${analysis.gg.prob <= 52 ? 'selected' : ''}">
                                <p class="font-black text-2xl mb-1">NG</p>
                                <p class="text-sm text-gray-400 mb-2">${(100 - analysis.gg.prob).toFixed(0)}%</p>
                                <span class="conf-badge ${confBadgeClass(100 - analysis.gg.conf)}">${(100 - analysis.gg.conf).toFixed(0)}%</span>
                                <button onclick="addToHistory('${safeMatch}', 'GG', 'NG', ${100 - analysis.gg.conf})" class="mt-3 w-full py-2 rounded-lg gradient-btn text-black text-sm font-bold">üíæ</button>
                            </div>
                        </div>
                    </div>

                    <!-- CORNER -->
                    <div class="glass p-5 mb-4">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-yellow-400 to-orange-500 flex items-center justify-center"><span class="text-lg">üö©</span></div>
                            <div><h3 class="font-bold text-lg">Corner</h3><p class="text-xs text-gray-500">Exp: ${analysis.corners.total.toFixed(1)}</p></div>
                        </div>
                        
                        <p class="text-sm font-semibold text-gray-400 mb-2">üìä Totale</p>
                        <div class="grid grid-cols-2 gap-2 mb-4">
                            ${analysis.corners.preds.map(p => `
                                <div class="pick-card flex items-center justify-between">
                                    <span class="font-bold">${p.pick} ${p.line}</span>
                                    <div class="flex items-center gap-2">
                                        <span class="conf-badge ${confBadgeClass(p.conf)}">${p.conf.toFixed(0)}%</span>
                                        <button onclick="addToHistory('${safeMatch}', 'Corner', '${p.pick} ${p.line}', ${p.conf})" class="w-8 h-8 rounded-lg bg-yellow-500/30 flex items-center justify-center">üíæ</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <p class="text-sm font-semibold text-gray-400 mb-2">üè† Casa (${analysis.corners.home.toFixed(1)})</p>
                        <div class="grid grid-cols-3 gap-2 mb-4">
                            ${analysis.corners.homePreds.map(p => `
                                <button onclick="addToHistory('${safeMatch}', 'Corner Casa', '${p.pick} ${p.line}', ${p.conf})" class="pick-card text-center py-2">
                                    <p class="font-bold text-sm">${p.pick} ${p.line}</p>
                                    <span class="conf-badge ${confBadgeClass(p.conf)} text-xs">${p.conf.toFixed(0)}%</span>
                                </button>
                            `).join('')}
                        </div>
                        
                        <p class="text-sm font-semibold text-gray-400 mb-2">üöå Ospite (${analysis.corners.away.toFixed(1)})</p>
                        <div class="grid grid-cols-3 gap-2">
                            ${analysis.corners.awayPreds.map(p => `
                                <button onclick="addToHistory('${safeMatch}', 'Corner Ospite', '${p.pick} ${p.line}', ${p.conf})" class="pick-card text-center py-2">
                                    <p class="font-bold text-sm">${p.pick} ${p.line}</p>
                                    <span class="conf-badge ${confBadgeClass(p.conf)} text-xs">${p.conf.toFixed(0)}%</span>
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <!-- CARDS -->
                    <div class="glass p-5 mb-4">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-red-400 to-pink-500 flex items-center justify-center"><span class="text-lg">üü®</span></div>
                            <div><h3 class="font-bold text-lg">Cartellini</h3><p class="text-xs text-gray-500">Exp: ${analysis.cards.total.toFixed(1)}</p></div>
                        </div>
                        
                        <p class="text-sm font-semibold text-gray-400 mb-2">üìä Totale</p>
                        <div class="grid grid-cols-2 gap-2 mb-4">
                            ${analysis.cards.preds.map(p => `
                                <div class="pick-card flex items-center justify-between">
                                    <span class="font-bold">${p.pick} ${p.line}</span>
                                    <div class="flex items-center gap-2">
                                        <span class="conf-badge ${confBadgeClass(p.conf)}">${p.conf.toFixed(0)}%</span>
                                        <button onclick="addToHistory('${safeMatch}', 'Cards', '${p.pick} ${p.line}', ${p.conf})" class="w-8 h-8 rounded-lg bg-red-500/30 flex items-center justify-center">üíæ</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <p class="text-sm font-semibold text-gray-400 mb-2">üè† Casa (${analysis.cards.home.toFixed(1)})</p>
                        <div class="grid grid-cols-2 gap-2 mb-4">
                            ${analysis.cards.homePreds.map(p => `
                                <button onclick="addToHistory('${safeMatch}', 'Cards Casa', '${p.pick} ${p.line}', ${p.conf})" class="pick-card text-center py-2">
                                    <p class="font-bold text-sm">${p.pick} ${p.line}</p>
                                    <span class="conf-badge ${confBadgeClass(p.conf)} text-xs">${p.conf.toFixed(0)}%</span>
                                </button>
                            `).join('')}
                        </div>
                        
                        <p class="text-sm font-semibold text-gray-400 mb-2">üöå Ospite (${analysis.cards.away.toFixed(1)})</p>
                        <div class="grid grid-cols-2 gap-2">
                            ${analysis.cards.awayPreds.map(p => `
                                <button onclick="addToHistory('${safeMatch}', 'Cards Ospite', '${p.pick} ${p.line}', ${p.conf})" class="pick-card text-center py-2">
                                    <p class="font-bold text-sm">${p.pick} ${p.line}</p>
                                    <span class="conf-badge ${confBadgeClass(p.conf)} text-xs">${p.conf.toFixed(0)}%</span>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderHistory() {
            const stats = getStats();
            return `
                <div class="p-4">
                    <button onclick="state.view='main';render()" class="flex items-center gap-2 text-gray-400 mb-4 hover:text-white">‚Üê Indietro</button>

                    <div class="glass-strong p-6 mb-6 glow-green">
                        <h3 class="font-bold text-lg mb-4">üìä Statistiche</h3>
                        <div class="grid grid-cols-4 gap-3">
                            <div class="text-center"><p class="text-3xl font-black">${stats.total}</p><p class="text-xs text-gray-400">Tot</p></div>
                            <div class="text-center"><p class="text-3xl font-black text-green-400">${stats.won}</p><p class="text-xs text-gray-400">Win</p></div>
                            <div class="text-center"><p class="text-3xl font-black text-red-400">${stats.lost}</p><p class="text-xs text-gray-400">Lost</p></div>
                            <div class="text-center"><p class="text-3xl font-black gradient-text">${stats.hitRate}%</p><p class="text-xs text-gray-400">Hit</p></div>
                        </div>
                        ${stats.total > 0 ? `<div class="mt-4 bg-black/30 rounded-xl p-3"><div class="w-full h-3 bg-gray-800 rounded-full overflow-hidden"><div class="h-full bg-gradient-to-r from-green-400 to-cyan-500 rounded-full" style="width: ${stats.hitRate}%"></div></div></div>` : ''}
                    </div>

                    <h3 class="font-bold text-lg mb-4">üìù Pronostici</h3>
                    ${state.history.length === 0 ? `<div class="glass p-8 text-center text-gray-400">Nessun pronostico</div>` : `
                        <div class="space-y-3">
                            ${state.history.map(e => {
                                const icon = e.pickType?.includes('Corner') ? 'üö©' : e.pickType?.includes('Card') ? 'üü®' : '‚öΩ';
                                const bg = e.result === 'won' ? 'result-won' : e.result === 'lost' ? 'result-lost' : '';
                                return `
                                    <div class="glass p-4 border ${bg}">
                                        <div class="flex items-start justify-between">
                                            <div class="flex-1">
                                                <div class="flex items-center gap-2 mb-1">
                                                    <span class="text-lg">${icon}</span>
                                                    <span class="font-bold text-sm">${escapeHtml(e.matchInfo)}</span>
                                                </div>
                                                <p class="text-cyan-400 font-semibold">${escapeHtml(e.pickType)}: ${escapeHtml(e.pickValue)}</p>
                                                <div class="flex items-center gap-2 mt-2">
                                                    <span class="conf-badge ${confBadgeClass(e.conf)}">${e.conf}%</span>
                                                    <span class="text-xs text-gray-500">${new Date(e.date).toLocaleDateString('it-IT')}</span>
                                                </div>
                                            </div>
                                            <div class="ml-4">
                                                ${e.result === null ? `
                                                    <div class="flex flex-col gap-2">
                                                        <button onclick="updateResult(${e.id},'won')" class="px-4 py-2 rounded-lg bg-green-500/20 text-green-400 font-bold text-sm">‚úì</button>
                                                        <button onclick="updateResult(${e.id},'lost')" class="px-4 py-2 rounded-lg bg-red-500/20 text-red-400 font-bold text-sm">‚úó</button>
                                                    </div>
                                                ` : `<span class="text-3xl">${e.result === 'won' ? '‚úÖ' : '‚ùå'}</span>`}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `}
                    <button onclick="if(confirm('Cancellare?')){state.history=[];saveHistory();render()}" class="w-full mt-6 py-3 glass rounded-xl text-red-400 text-sm font-bold">üóëÔ∏è Cancella</button>
                </div>
            `;
        }

        function selectMatch(i) {
            state.selectedMatch = state.matches[i];
            state.view = 'analysis';
            render();
        }

        function render() {
            const app = document.getElementById('app');
            switch (state.view) {
                case 'matches': app.innerHTML = renderMatches(); break;
                case 'analysis': app.innerHTML = renderAnalysis(); break;
                case 'history': app.innerHTML = renderHistory(); break;
                default: app.innerHTML = renderMain();
            }
            const dateInput = document.getElementById('dateInput');
            if (dateInput) dateInput.addEventListener('change', (e) => { state.date = e.target.value; });
        }

        render();
    </script>
</body>
</html>
